<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Fair Candidate Screening System &#8212; Fair-Candidate-Screening-System 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=2709fde1"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to Fair Candidate Screening System’s documentation!" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="fair-candidate-screening-system">
<h1>Fair Candidate Screening System<a class="headerlink" href="#fair-candidate-screening-system" title="Link to this heading">¶</a></h1>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Link to this heading">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!git clone https://github.com/pikalab-unibo-students/master-thesis-dizio-ay2324.git</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">utils</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

<span class="c1"># Fairlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">chardet</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fairlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fairlearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">demographic_parity_ratio</span><span class="p">,</span> <span class="n">equalized_odds_ratio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fairlib.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">LFR</span><span class="p">,</span> <span class="n">DisparateImpactRemover</span><span class="p">,</span> <span class="n">Reweighing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fairlib.inprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdversarialDebiasing</span>

<span class="c1"># Statistics</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="c1"># Preprocessing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrdinalEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Classification</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>

<span class="c1"># Post-processing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aif360.algorithms.postprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedEqOddsPostprocessing</span><span class="p">,</span> <span class="n">EqOddsPostprocessing</span><span class="p">,</span> <span class="n">RejectOptionClassification</span><span class="p">,</span> <span class="n">DeterministicReranking</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aif360.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardDataset</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allowing reproducibility</span>
<span class="n">random_seed</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="dataset-loading">
<h2>Dataset Loading<a class="headerlink" href="#dataset-loading" title="Link to this heading">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_path</span> <span class="o">=</span> <span class="s1">&#39;direct_matching_20240213.csv&#39;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">chardet</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="data-preparation">
<h2>Data Preparation<a class="headerlink" href="#data-preparation" title="Link to this heading">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cand_id</th>
      <th>job_id</th>
      <th>distance_km</th>
      <th>match_score</th>
      <th>match_rank</th>
      <th>cand_gender</th>
      <th>cand_age_bucket</th>
      <th>cand_domicile_province</th>
      <th>cand_domicile_region</th>
      <th>cand_education</th>
      <th>job_contract_type</th>
      <th>job_professional_category</th>
      <th>job_sector</th>
      <th>job_work_province</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5,664,912</td>
      <td>OFF_1011_1427</td>
      <td>32.327042</td>
      <td>99.573387</td>
      <td>1</td>
      <td>Male</td>
      <td>45-54</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4,999,120</td>
      <td>OFF_1011_1427</td>
      <td>15.595593</td>
      <td>99.210564</td>
      <td>2</td>
      <td>Male</td>
      <td>35-44</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5,413,671</td>
      <td>OFF_1011_1427</td>
      <td>31.348877</td>
      <td>99.118614</td>
      <td>3</td>
      <td>Female</td>
      <td>45-54</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5,965,090</td>
      <td>OFF_1011_1427</td>
      <td>66.315598</td>
      <td>97.409767</td>
      <td>4</td>
      <td>Male</td>
      <td>15-24</td>
      <td>TS</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5,771,219</td>
      <td>OFF_1011_1427</td>
      <td>15.595593</td>
      <td>97.323875</td>
      <td>5</td>
      <td>Female</td>
      <td>35-44</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2,216,205</td>
      <td>OFF_1011_1427</td>
      <td>24.946939</td>
      <td>96.922318</td>
      <td>6</td>
      <td>Male</td>
      <td>55-74</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>Diploma / Accademia : Geometra</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
    </tr>
    <tr>
      <th>6</th>
      <td>4,594,051</td>
      <td>OFF_1011_1427</td>
      <td>27.959969</td>
      <td>96.245216</td>
      <td>7</td>
      <td>Male</td>
      <td>55-74</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
    </tr>
    <tr>
      <th>7</th>
      <td>5,148,878</td>
      <td>OFF_1011_1427</td>
      <td>25.512180</td>
      <td>96.235245</td>
      <td>8</td>
      <td>Male</td>
      <td>25-34</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
    </tr>
    <tr>
      <th>8</th>
      <td>5,933,345</td>
      <td>OFF_1011_1427</td>
      <td>28.856832</td>
      <td>96.009712</td>
      <td>9</td>
      <td>Female</td>
      <td>45-54</td>
      <td>GO</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
    </tr>
    <tr>
      <th>9</th>
      <td>7,204,128</td>
      <td>OFF_1011_1427</td>
      <td>31.348877</td>
      <td>95.802277</td>
      <td>10</td>
      <td>Female</td>
      <td>35-44</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
    </tr>
    <tr>
      <th>10</th>
      <td>5,025,089</td>
      <td>OFF_1038_1739</td>
      <td>17.786076</td>
      <td>99.949821</td>
      <td>1</td>
      <td>Male</td>
      <td>25-34</td>
      <td>MI</td>
      <td>LOMBARDIA</td>
      <td>Diploma / Accademia : Liceo scientifico</td>
      <td>Ricerca e selezione</td>
      <td>Macellaio (m/f)</td>
      <td>GDO / Retail / Commessi / Scaffalisti</td>
      <td>MI</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;match_rank&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;cand_gender&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gender Distribution over Match Ranks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Match Rank&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_11_0.png" src="_images/main_11_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;match_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">99.3</span><span class="p">][</span><span class="s1">&#39;match_score&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of Match Score&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Match Score&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_12_0.png" src="_images/main_12_0.png" />
<p>We can assume that a candidate is hired if its match score is greater
than a significant threshold, for instance, th=99.8</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hired_threshold</span> <span class="o">=</span> <span class="mf">99.8</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;hired&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;match_score&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">hired_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">8647</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;hired&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">5297</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hired&#39;</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;hired&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hired Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_20_0.png" src="_images/main_20_0.png" />
<p>Both the match rank and the match score are useless now that we extract
the label, so we can drop them.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;match_score&#39;</span><span class="p">,</span><span class="s1">&#39;match_rank&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cand_id</th>
      <th>job_id</th>
      <th>distance_km</th>
      <th>cand_gender</th>
      <th>cand_age_bucket</th>
      <th>cand_domicile_province</th>
      <th>cand_domicile_region</th>
      <th>cand_education</th>
      <th>job_contract_type</th>
      <th>job_professional_category</th>
      <th>job_sector</th>
      <th>job_work_province</th>
      <th>hired</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5,664,912</td>
      <td>OFF_1011_1427</td>
      <td>32.327042</td>
      <td>Male</td>
      <td>45-54</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4,999,120</td>
      <td>OFF_1011_1427</td>
      <td>15.595593</td>
      <td>Male</td>
      <td>35-44</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5,413,671</td>
      <td>OFF_1011_1427</td>
      <td>31.348877</td>
      <td>Female</td>
      <td>45-54</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5,965,090</td>
      <td>OFF_1011_1427</td>
      <td>66.315598</td>
      <td>Male</td>
      <td>15-24</td>
      <td>TS</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5,771,219</td>
      <td>OFF_1011_1427</td>
      <td>15.595593</td>
      <td>Female</td>
      <td>35-44</td>
      <td>UD</td>
      <td>FRIULI VENEZIA GIULIA</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="data-preprocessing">
<h2>Data Preprocessing<a class="headerlink" href="#data-preprocessing" title="Link to this heading">¶</a></h2>
<p>Before continuing with the data analysis we want to ensure that missing
values are handled correctly and the data are ready to be feed in a
classifier. Let’s inspect some of their statistics.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Examples in the dataset: </span><span class="si">{</span><span class="n">df1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Examples</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">dataset</span><span class="p">:</span> <span class="mi">8647</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cand_id</th>
      <th>job_id</th>
      <th>distance_km</th>
      <th>cand_gender</th>
      <th>cand_age_bucket</th>
      <th>cand_domicile_province</th>
      <th>cand_domicile_region</th>
      <th>cand_education</th>
      <th>job_contract_type</th>
      <th>job_professional_category</th>
      <th>job_sector</th>
      <th>job_work_province</th>
      <th>hired</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>8647</td>
      <td>8647</td>
      <td>8647.000000</td>
      <td>8647</td>
      <td>8646</td>
      <td>8644</td>
      <td>8642</td>
      <td>2341</td>
      <td>8647</td>
      <td>8647</td>
      <td>8647</td>
      <td>8647</td>
      <td>8647.000000</td>
    </tr>
    <tr>
      <th>unique</th>
      <td>6798</td>
      <td>865</td>
      <td>NaN</td>
      <td>2</td>
      <td>5</td>
      <td>79</td>
      <td>18</td>
      <td>433</td>
      <td>3</td>
      <td>247</td>
      <td>26</td>
      <td>53</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>top</th>
      <td>6,550,205</td>
      <td>OFF_1011_1427</td>
      <td>NaN</td>
      <td>Male</td>
      <td>25-34</td>
      <td>MI</td>
      <td>LOMBARDIA</td>
      <td>Licenza media</td>
      <td>Lavoro subordinato</td>
      <td>Operaio Generico Metalmeccanico</td>
      <td>Operai Generici</td>
      <td>MI</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>freq</th>
      <td>18</td>
      <td>10</td>
      <td>NaN</td>
      <td>4766</td>
      <td>2936</td>
      <td>1341</td>
      <td>3989</td>
      <td>433</td>
      <td>5658</td>
      <td>770</td>
      <td>2829</td>
      <td>1689</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>29.769432</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.612582</td>
    </tr>
    <tr>
      <th>std</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>23.493063</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.487189</td>
    </tr>
    <tr>
      <th>min</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>12.253924</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>23.447361</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>41.754654</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>99.966797</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div><p>Most of the variables doen’t miss any value, except for the candidate
domicile province which misses just 3 values, the candidate domicile
region which misses only 5 values, the candidate age which misses only 1
value and the candidate education, which instead misses way more values.
We can account for the 3 missing values by simply drop the related rows,
but we must find a default value for the education since the rows
containing missing values are too much.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_domicile_province&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_domicile_region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_age_bucket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
</pre></div>
</div>
<p>In general, we can keep all the numerical values, but we have to account
for the categorical ones in order to feed a classifier. In the next
paragraphs we will focus on the features that require our attention.</p>
<section id="ids">
<h3>IDs<a class="headerlink" href="#ids" title="Link to this heading">¶</a></h3>
<p>Candidate id and job id are meaningless for the task of bias detection,
hence we can easily drop them.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;cand_id&#39;</span><span class="p">,</span><span class="s1">&#39;job_id&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="distance-km">
<h3>Distance Km<a class="headerlink" href="#distance-km" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mf">8639.000000</span>
<span class="n">mean</span>       <span class="mf">29.754485</span>
<span class="n">std</span>        <span class="mf">23.484031</span>
<span class="nb">min</span>         <span class="mf">0.000000</span>
<span class="mi">25</span><span class="o">%</span>        <span class="mf">12.252331</span>
<span class="mi">50</span><span class="o">%</span>        <span class="mf">23.437698</span>
<span class="mi">75</span><span class="o">%</span>        <span class="mf">41.751572</span>
<span class="nb">max</span>        <span class="mf">99.966797</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">distance_km</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<p>We can approximate the distance by rounding it.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span> <span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mf">8639.000000</span>
<span class="n">mean</span>       <span class="mf">29.746846</span>
<span class="n">std</span>        <span class="mf">23.475636</span>
<span class="nb">min</span>         <span class="mf">0.000000</span>
<span class="mi">25</span><span class="o">%</span>        <span class="mf">12.000000</span>
<span class="mi">50</span><span class="o">%</span>        <span class="mf">23.000000</span>
<span class="mi">75</span><span class="o">%</span>        <span class="mf">42.000000</span>
<span class="nb">max</span>       <span class="mf">100.000000</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">distance_km</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<p>First of all, let’s inspect the distribution.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the distribution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Km&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distance Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_40_0.png" src="_images/main_40_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;distance_km&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;hired&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">])))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hirings Distribution over Distances&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Distance Km&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_41_0.png" src="_images/main_41_0.png" />
<p>From this plot we may suspect some bias related to the region of the
candidate.</p>
</section>
<section id="candidate-gender">
<h3>Candidate Gender<a class="headerlink" href="#candidate-gender" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the distribution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gender Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_44_0.png" src="_images/main_44_0.png" />
<p>The dataset is imbalanced, but this tell us nothing about any possible
bias or unfairness. In order to spot any kind of unfairness we should
compare this distribution with the hirings.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;cand_gender&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hirings Distribution over Gender&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_46_0.png" src="_images/main_46_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;job_sector&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;cand_gender&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gender Distribution over Job Sectors&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Sector&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_47_0.png" src="_images/main_47_0.png" />
<p>The difference in the distributions may be due to high demand in that
sectors</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sensitive_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cand_gender&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="candidate-province">
<h3>Candidate Province<a class="headerlink" href="#candidate-province" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_domicile_province&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">count</span>     <span class="mi">8639</span>
<span class="n">unique</span>      <span class="mi">78</span>
<span class="n">top</span>         <span class="n">MI</span>
<span class="n">freq</span>      <span class="mi">1340</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">cand_domicile_province</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the distribution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_domicile_province&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Province&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Candidate Province Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_52_0.png" src="_images/main_52_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;cand_domicile_province&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hirings Distribution over Candidate Province&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Province&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_53_0.png" src="_images/main_53_0.png" />
<p>Here we can spot some bias towards the candidates coming from the north
of Italy, but we need to aggregate the data in order to have a clearer
overview.</p>
<p>In order to preprocess this feature, we have to ensure that even the job
work province will be coherent with the candidate province, therefore we
will use the same encoder for both of them.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">province_encoder</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">()</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_domicile_province&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">province_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;cand_domicile_province&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="domicile-region">
<h3>Domicile Region<a class="headerlink" href="#domicile-region" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_domicile_region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">count</span>          <span class="mi">8639</span>
<span class="n">unique</span>           <span class="mi">18</span>
<span class="n">top</span>       <span class="n">LOMBARDIA</span>
<span class="n">freq</span>           <span class="mi">3988</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">cand_domicile_region</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the distribution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_domicile_region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Domicile Region&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Domicile Region Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_59_0.png" src="_images/main_59_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_copy</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;gender_region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;cand_domicile_region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;cand_gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_copy</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;gender_region&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hirings Distribution over Candidate Region&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Region&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_61_0.png" src="_images/main_61_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;gender_region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gender_region</span>
<span class="n">LOMBARDIA</span> <span class="n">Male</span>                  <span class="mi">2222</span>
<span class="n">LOMBARDIA</span> <span class="n">Female</span>                <span class="mi">1766</span>
<span class="n">EMILIA</span> <span class="n">ROMAGNA</span> <span class="n">Male</span>              <span class="mi">673</span>
<span class="n">VENETO</span> <span class="n">Male</span>                      <span class="mi">670</span>
<span class="n">EMILIA</span> <span class="n">ROMAGNA</span> <span class="n">Female</span>            <span class="mi">557</span>
<span class="n">VENETO</span> <span class="n">Female</span>                    <span class="mi">545</span>
<span class="n">PIEMONTE</span> <span class="n">Male</span>                    <span class="mi">445</span>
<span class="n">PIEMONTE</span> <span class="n">Female</span>                  <span class="mi">366</span>
<span class="n">FRIULI</span> <span class="n">VENEZIA</span> <span class="n">GIULIA</span> <span class="n">Male</span>       <span class="mi">253</span>
<span class="n">LAZIO</span> <span class="n">Female</span>                     <span class="mi">222</span>
<span class="n">TOSCANA</span> <span class="n">Female</span>                   <span class="mi">149</span>
<span class="n">TOSCANA</span> <span class="n">Male</span>                     <span class="mi">118</span>
<span class="n">FRIULI</span> <span class="n">VENEZIA</span> <span class="n">GIULIA</span> <span class="n">Female</span>     <span class="mi">114</span>
<span class="n">TRENTINO</span> <span class="n">ALTO</span> <span class="n">ADIGE</span> <span class="n">Male</span>         <span class="mi">111</span>
<span class="n">LAZIO</span> <span class="n">Male</span>                       <span class="mi">100</span>
<span class="n">MARCHE</span> <span class="n">Male</span>                       <span class="mi">75</span>
<span class="n">ABRUZZO</span> <span class="n">Male</span>                      <span class="mi">54</span>
<span class="n">MARCHE</span> <span class="n">Female</span>                     <span class="mi">51</span>
<span class="n">TRENTINO</span> <span class="n">ALTO</span> <span class="n">ADIGE</span> <span class="n">Female</span>        <span class="mi">28</span>
<span class="n">LIGURIA</span> <span class="n">Female</span>                    <span class="mi">26</span>
<span class="n">SARDEGNA</span> <span class="n">Male</span>                     <span class="mi">22</span>
<span class="n">ABRUZZO</span> <span class="n">Female</span>                    <span class="mi">19</span>
<span class="n">VALLE</span> <span class="n">D</span><span class="s1">&#39;AOSTA Female              18</span>
<span class="n">SARDEGNA</span> <span class="n">Female</span>                    <span class="mi">9</span>
<span class="n">MOLISE</span> <span class="n">Male</span>                        <span class="mi">5</span>
<span class="n">UMBRIA</span> <span class="n">Male</span>                        <span class="mi">5</span>
<span class="n">LIGURIA</span> <span class="n">Male</span>                       <span class="mi">4</span>
<span class="n">UMBRIA</span> <span class="n">Female</span>                      <span class="mi">4</span>
<span class="n">MOLISE</span> <span class="n">Female</span>                      <span class="mi">2</span>
<span class="n">VALLE</span> <span class="n">D</span><span class="s1">&#39;AOSTA Male                 2</span>
<span class="n">PUGLIA</span> <span class="n">Male</span>                        <span class="mi">1</span>
<span class="n">CALABRIA</span> <span class="n">Female</span>                    <span class="mi">1</span>
<span class="n">CAMPANIA</span> <span class="n">Female</span>                    <span class="mi">1</span>
<span class="n">PUGLIA</span> <span class="n">Female</span>                      <span class="mi">1</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<p>This last plot shows that there are no biases in the region, thus we can
assume that there are no bias in the province feature too. Note that the
regions of the south are not well represented, so any bias related to
the north-south discrimination won’t be catched.</p>
<p>A one-hot wencoding would be too heavy for too much regions, thus we can
group them into south, central and north regions and then one-hot encode
them.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">region_groups</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># North</span>
    <span class="s1">&#39;piemonte&#39;</span><span class="p">:</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valle d</span><span class="se">\&#39;</span><span class="s1">aosta&#39;</span><span class="p">:</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lombardia&#39;</span><span class="p">:</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span>
    <span class="s1">&#39;veneto&#39;</span><span class="p">:</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span>
    <span class="s1">&#39;friuli venezia giulia&#39;</span><span class="p">:</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span>
    <span class="s1">&#39;liguria&#39;</span><span class="p">:</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span>
    <span class="s1">&#39;emilia romagna&#39;</span><span class="p">:</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span>
    <span class="s1">&#39;trentino alto adige&#39;</span><span class="p">:</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span>

    <span class="c1"># Central</span>
    <span class="s1">&#39;toscana&#39;</span><span class="p">:</span> <span class="s1">&#39;central&#39;</span><span class="p">,</span>
    <span class="s1">&#39;umbria&#39;</span><span class="p">:</span> <span class="s1">&#39;central&#39;</span><span class="p">,</span>
    <span class="s1">&#39;marche&#39;</span><span class="p">:</span> <span class="s1">&#39;central&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lazio&#39;</span><span class="p">:</span> <span class="s1">&#39;central&#39;</span><span class="p">,</span>

    <span class="c1"># South</span>
    <span class="s1">&#39;abruzzo&#39;</span><span class="p">:</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span>
    <span class="s1">&#39;molise&#39;</span><span class="p">:</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span>
    <span class="s1">&#39;campania&#39;</span><span class="p">:</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span>
    <span class="s1">&#39;puglia&#39;</span><span class="p">:</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span>
    <span class="s1">&#39;basilicata&#39;</span><span class="p">:</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span>
    <span class="s1">&#39;calabria&#39;</span><span class="p">:</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span>

    <span class="c1"># Islands</span>
    <span class="s1">&#39;sicilia&#39;</span><span class="p">:</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sardegna&#39;</span><span class="p">:</span> <span class="s1">&#39;south&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped_regions</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_domicile_region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span> <span class="p">:</span> <span class="n">region_groups</span><span class="p">[</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">r</span><span class="p">)])</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;grouped_regions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped_regions</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;grouped_regions&#39;</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hirings Distribution over Candidate Region&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Region&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_67_0.png" src="_images/main_67_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;cand_domicile_region&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;cand_gender&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>distance_km</th>
      <th>cand_age_bucket</th>
      <th>cand_domicile_province</th>
      <th>cand_education</th>
      <th>job_contract_type</th>
      <th>job_professional_category</th>
      <th>job_sector</th>
      <th>job_work_province</th>
      <th>hired</th>
      <th>grouped_regions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>32</td>
      <td>45-54</td>
      <td>71.0</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
      <td>0</td>
      <td>north Male</td>
    </tr>
    <tr>
      <th>1</th>
      <td>16</td>
      <td>35-44</td>
      <td>71.0</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
      <td>0</td>
      <td>north Male</td>
    </tr>
    <tr>
      <th>2</th>
      <td>31</td>
      <td>45-54</td>
      <td>71.0</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
      <td>0</td>
      <td>north Female</td>
    </tr>
    <tr>
      <th>3</th>
      <td>66</td>
      <td>15-24</td>
      <td>69.0</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
      <td>0</td>
      <td>north Male</td>
    </tr>
    <tr>
      <th>4</th>
      <td>16</td>
      <td>35-44</td>
      <td>71.0</td>
      <td>NaN</td>
      <td>Lavoro subordinato</td>
      <td>Geometra e tecnico di costruzioni civili e ind...</td>
      <td>Progettisti / Design / Grafici</td>
      <td>UD</td>
      <td>0</td>
      <td>north Female</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;grouped_regions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grouped_regions</span>
<span class="n">north</span> <span class="n">Male</span>        <span class="mi">4380</span>
<span class="n">north</span> <span class="n">Female</span>      <span class="mi">3420</span>
<span class="n">central</span> <span class="n">Female</span>     <span class="mi">426</span>
<span class="n">central</span> <span class="n">Male</span>       <span class="mi">298</span>
<span class="n">south</span> <span class="n">Male</span>          <span class="mi">82</span>
<span class="n">south</span> <span class="n">Female</span>        <span class="mi">33</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
</section>
<section id="age-buckets">
<h3>Age Buckets<a class="headerlink" href="#age-buckets" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_age_bucket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;45-54&#39;</span><span class="p">,</span> <span class="s1">&#39;35-44&#39;</span><span class="p">,</span> <span class="s1">&#39;15-24&#39;</span><span class="p">,</span> <span class="s1">&#39;55-74&#39;</span><span class="p">,</span> <span class="s1">&#39;25-34&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Null age buckets: </span><span class="si">{</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_age_bucket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Null</span> <span class="n">age</span> <span class="n">buckets</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Since it is only one we can safely drop it.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_age_bucket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cand_age_bucket</span>
<span class="mi">25</span><span class="o">-</span><span class="mi">34</span>    <span class="mi">2935</span>
<span class="mi">35</span><span class="o">-</span><span class="mi">44</span>    <span class="mi">2129</span>
<span class="mi">45</span><span class="o">-</span><span class="mi">54</span>    <span class="mi">1777</span>
<span class="mi">55</span><span class="o">-</span><span class="mi">74</span>     <span class="mi">956</span>
<span class="mi">15</span><span class="o">-</span><span class="mi">24</span>     <span class="mi">842</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_age_bucket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Age bucket&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Age Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_76_0.png" src="_images/main_76_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;cand_age_bucket&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;hired&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;15-24&#39;</span><span class="p">,</span> <span class="s1">&#39;25-34&#39;</span><span class="p">,</span> <span class="s1">&#39;35-44&#39;</span><span class="p">,</span> <span class="s1">&#39;45-54&#39;</span><span class="p">,</span> <span class="s1">&#39;55-74&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hirings Distribution over Candidate Age&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Age Bucket&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_77_0.png" src="_images/main_77_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sensitive_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cand_age_bucket&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can discretize them since they are numerical but preserves the order,
thus we will use progressive enumeration.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">age_bucket_order</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;15-24&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;25-34&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;35-44&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;45-54&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;55-74&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_age_bucket&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_age_bucket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">age_bucket_order</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_age_bucket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cand_age_bucket</span>
<span class="mi">1</span>    <span class="mi">2935</span>
<span class="mi">2</span>    <span class="mi">2129</span>
<span class="mi">3</span>    <span class="mi">1777</span>
<span class="mi">4</span>     <span class="mi">956</span>
<span class="mi">0</span>     <span class="mi">842</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
</section>
<section id="candidate-education">
<h3>Candidate Education<a class="headerlink" href="#candidate-education" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">map_education_level</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Clean common formatting inconsistencies</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;laurea&#39;</span><span class="p">,</span> <span class="s1">&#39;degree&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;diploma&#39;</span><span class="p">,</span> <span class="s1">&#39;degree&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;dottorato&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;phd&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;research doctorate&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;PhD&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;master&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;lm-&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Graduate&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;bachelor&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;l-&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Undergraduate&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;higher technical institute&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;its&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Higher Technical Institute&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;qualification&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;certificate&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;operator&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Vocational Certificate&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;high school&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;liceo&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;technician&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;technical&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;High School&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;middle school&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;scuola media&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Middle School&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;elementary&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Elementary School&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Other&#39;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_education&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_education&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">map_education_level</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_education&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cand_education</span>
<span class="n">Unknown</span>                       <span class="mi">6298</span>
<span class="n">Other</span>                         <span class="mi">1546</span>
<span class="n">Vocational</span> <span class="n">Certificate</span>         <span class="mi">284</span>
<span class="n">High</span> <span class="n">School</span>                    <span class="mi">172</span>
<span class="n">Higher</span> <span class="n">Technical</span> <span class="n">Institute</span>     <span class="mi">158</span>
<span class="n">Graduate</span>                       <span class="mi">120</span>
<span class="n">Undergraduate</span>                   <span class="mi">56</span>
<span class="n">PhD</span>                              <span class="mi">5</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the distribution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_education&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_education&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Education&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Education Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_86_0.png" src="_images/main_86_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;cand_education&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hirings Distribution over Education&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Education&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_87_0.png" src="_images/main_87_0.png" />
<p>These results are probably not about any bias. However, we cannot say
much looking only at this feature.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">education_encoder</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">()</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cand_education&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">education_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;cand_education&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="job-contract-type">
<h3>Job Contract Type<a class="headerlink" href="#job-contract-type" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_contract_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">count</span>                   <span class="mi">8639</span>
<span class="n">unique</span>                     <span class="mi">3</span>
<span class="n">top</span>       <span class="n">Lavoro</span> <span class="n">subordinato</span>
<span class="n">freq</span>                    <span class="mi">5653</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">job_contract_type</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_contract_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">job_contract_type</span>
<span class="n">Lavoro</span> <span class="n">subordinato</span>     <span class="mi">5653</span>
<span class="n">Ricerca</span> <span class="n">e</span> <span class="n">selezione</span>    <span class="mi">2966</span>
<span class="n">Other</span>                    <span class="mi">20</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">contract_encoder</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">()</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_contract_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contract_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;job_contract_type&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="job-category">
<h3>Job Category<a class="headerlink" href="#job-category" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_professional_category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">count</span>                                <span class="mi">8639</span>
<span class="n">unique</span>                                <span class="mi">247</span>
<span class="n">top</span>       <span class="n">Operaio</span> <span class="n">Generico</span> <span class="n">Metalmeccanico</span>
<span class="n">freq</span>                                  <span class="mi">770</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">job_professional_category</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">category_encoder</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">()</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_professional_category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;job_professional_category&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="job-sector">
<h3>Job Sector<a class="headerlink" href="#job-sector" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">count</span>                <span class="mi">8639</span>
<span class="n">unique</span>                 <span class="mi">26</span>
<span class="n">top</span>       <span class="n">Operai</span> <span class="n">Generici</span>
<span class="n">freq</span>                 <span class="mi">2827</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">job_sector</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the distribution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Sector&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Job Sector Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_99_0.png" src="_images/main_99_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counts</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">min_count</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1">#Statistically meaningful</span>

<span class="n">rare</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&lt;</span> <span class="n">min_count</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

<span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">rare</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;job_sector&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hirings Distribution over Job Sector&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Sector&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Hired&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_101_0.png" src="_images/main_101_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sector_encoder</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">()</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;job_sector&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="job-work-province">
<h3>Job Work Province<a class="headerlink" href="#job-work-province" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_work_province&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">count</span>     <span class="mi">8520</span>
<span class="n">unique</span>      <span class="mi">53</span>
<span class="n">top</span>        <span class="n">MI</span>
<span class="n">freq</span>      <span class="mi">1607</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">job_work_province</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the distribution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_work_province&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Work Province&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Work Province Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_105_0.png" src="_images/main_105_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;job_work_province&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">province_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;job_work_province&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="considerations">
<h3>Considerations<a class="headerlink" href="#considerations" title="Link to this heading">¶</a></h3>
<p>Let’s check the statistics of the dataset after the preprocessing</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>distance_km</th>
      <th>cand_age_bucket</th>
      <th>cand_domicile_province</th>
      <th>cand_education</th>
      <th>job_contract_type</th>
      <th>job_professional_category</th>
      <th>job_sector</th>
      <th>job_work_province</th>
      <th>hired</th>
      <th>grouped_regions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>8520.000000</td>
      <td>8520.000000</td>
      <td>8520.000000</td>
      <td>8520.000000</td>
      <td>8520.000000</td>
      <td>8520.000000</td>
      <td>8520.000000</td>
      <td>8520.000000</td>
      <td>8520.000000</td>
      <td>8520</td>
    </tr>
    <tr>
      <th>unique</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6</td>
    </tr>
    <tr>
      <th>top</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>north Male</td>
    </tr>
    <tr>
      <th>freq</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4350</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>29.658803</td>
      <td>1.892019</td>
      <td>39.069131</td>
      <td>5.233685</td>
      <td>0.677465</td>
      <td>136.788615</td>
      <td>9.522183</td>
      <td>27.065258</td>
      <td>0.610681</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>std</th>
      <td>23.349403</td>
      <td>1.170752</td>
      <td>23.577801</td>
      <td>1.530368</td>
      <td>0.945372</td>
      <td>67.772409</td>
      <td>4.105599</td>
      <td>15.813288</td>
      <td>0.487625</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>12.000000</td>
      <td>1.000000</td>
      <td>11.000000</td>
      <td>6.000000</td>
      <td>0.000000</td>
      <td>91.000000</td>
      <td>7.000000</td>
      <td>9.000000</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>23.000000</td>
      <td>2.000000</td>
      <td>38.000000</td>
      <td>6.000000</td>
      <td>0.000000</td>
      <td>126.000000</td>
      <td>12.000000</td>
      <td>26.000000</td>
      <td>1.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>42.000000</td>
      <td>3.000000</td>
      <td>59.000000</td>
      <td>6.000000</td>
      <td>2.000000</td>
      <td>203.000000</td>
      <td>12.000000</td>
      <td>44.000000</td>
      <td>1.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>max</th>
      <td>100.000000</td>
      <td>4.000000</td>
      <td>77.000000</td>
      <td>7.000000</td>
      <td>2.000000</td>
      <td>246.000000</td>
      <td>17.000000</td>
      <td>52.000000</td>
      <td>1.000000</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div><p>As we can observe, there are no more missing values, and the target
lable distribution is almosto uniform.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sensitive_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;grouped_regions&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sensitive_features</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="bias-detection">
<h2>Bias detection<a class="headerlink" href="#bias-detection" title="Link to this heading">¶</a></h2>
<p>Detecting bias on the dataset using Statistical Parity Difference</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spd</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">statistical_parity_difference</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">central</span> <span class="n">Female</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.032443228428667314</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">central</span> <span class="n">Male</span><span class="p">):</span> <span class="mf">0.1391642128509833</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">north</span> <span class="n">Female</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.03122806966815528</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">north</span> <span class="n">Male</span><span class="p">):</span> <span class="mf">0.005383279583229983</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">south</span> <span class="n">Female</span><span class="p">):</span> <span class="mf">0.5522135458508736</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">south</span> <span class="n">Male</span><span class="p">):</span> <span class="mf">0.08712907347134619</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">central</span> <span class="n">Female</span><span class="p">):</span> <span class="mf">0.032443228428667314</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">central</span> <span class="n">Male</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.1391642128509833</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">north</span> <span class="n">Female</span><span class="p">):</span> <span class="mf">0.03122806966815539</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">north</span> <span class="n">Male</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.005383279583230038</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">south</span> <span class="n">Female</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.5522135458508735</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="n">south</span> <span class="n">Male</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.08712907347134624</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="n">spd</span><span class="p">[{</span><span class="s1">&#39;hired&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
<span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spd</span><span class="p">[{</span><span class="s1">&#39;hired&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Perfect Fairness (0)&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Minimal Disparity (0.1)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Moderate Disparity (0.2)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Significant Disparity (0.3)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">])</span>


<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Statistical Parity Difference for hired=True&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;SPD Value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_117_0.png" src="_images/main_117_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped_regions_encoder</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">()</span>
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;grouped_regions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped_regions_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;grouped_regions&#39;</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spd1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">statistical_parity_difference</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spd1</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mf">0.032443228428667314</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mf">0.1391642128509833</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mf">0.03122806966815528</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mf">0.005383279583229983</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mf">0.5522135458508736</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mf">0.08712907347134619</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mf">0.032443228428667314</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mf">0.1391642128509833</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mf">0.03122806966815539</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mf">0.005383279583230038</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mf">0.5522135458508735</span>
<span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mf">0.08712907347134624</span>
</pre></div>
</div>
<section id="correlation-matrix">
<h3>Correlation Matrix<a class="headerlink" href="#correlation-matrix" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Correlation Matrix&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_122_0.png" src="_images/main_122_0.png" />
</section>
</section>
<section id="bias-mitigation-techniques">
<h2>Bias mitigation techniques<a class="headerlink" href="#bias-mitigation-techniques" title="Link to this heading">¶</a></h2>
<section id="utils">
<h3>Utils<a class="headerlink" href="#utils" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sensitive_feature</span> <span class="o">=</span> <span class="s1">&#39;grouped_regions&#39;</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">preprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">preprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_performance_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;dpr&#39;</span><span class="p">:</span> <span class="n">demographic_parity_ratio</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="o">=</span><span class="n">sensitive_features</span><span class="p">),</span>
        <span class="s1">&#39;eor&#39;</span><span class="p">:</span> <span class="n">equalized_odds_ratio</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="o">=</span><span class="n">sensitive_features</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">X_test_copy</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_test_copy</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_copy</span><span class="p">)</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

    <span class="n">spd</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">statistical_parity_difference</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">spd</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">metrics_bar_plot</span><span class="p">(</span><span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">,</span> <span class="n">label1</span><span class="p">,</span> <span class="n">label2</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Metric Comparison (mean ± std)&quot;</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="n">fold_dicts</span><span class="p">):</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">fold</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="n">fold_dicts</span><span class="p">]</span>
            <span class="c1"># Usa nanmean e nanstd per evitare problemi con NaN</span>
            <span class="n">mean_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">std_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_val</span><span class="p">)</span>
            <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stds</span><span class="p">)</span>

    <span class="n">mean1</span><span class="p">,</span> <span class="n">std1</span> <span class="o">=</span> <span class="n">summarise</span><span class="p">(</span><span class="n">dict1</span><span class="p">)</span>
    <span class="n">mean2</span><span class="p">,</span> <span class="n">std2</span> <span class="o">=</span> <span class="n">summarise</span><span class="p">(</span><span class="n">dict2</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">[</span><span class="n">mean1</span><span class="p">,</span> <span class="n">mean2</span><span class="p">],</span> <span class="p">[</span><span class="n">std1</span><span class="p">,</span> <span class="n">std2</span><span class="p">],</span> <span class="p">[</span><span class="n">label1</span><span class="p">,</span> <span class="n">label2</span><span class="p">]):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>  <span class="c1"># leggermente sopra 1 per sicurezza</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Simple_NN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Simple_NN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">input_dim</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer3</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</section>
<section id="pre-processing">
<h3>Pre-Processing<a class="headerlink" href="#pre-processing" title="Link to this heading">¶</a></h3>
<p>In this section, we preprocess the dataset to prepare it for fair
machine learning analysis. The preprocessing steps include handling
missing values, encoding categorical variables, and normalizing
numerical features. We also define the sensitive attribute(s) for
fairness evaluation.</p>
<p><strong>Fairness Metrics Used:</strong> - <strong>Demographic Parity Ratio (DPR):</strong>
Measures the ratio of positive outcomes across sensitive groups. -
<strong>Equalized Odds Ratio (EOR):</strong> Compares true positive and false
positive rates across groups. - <strong>Statistical Parity Difference (SPD):</strong>
Assesses the difference in selection rates between groups.</p>
<p><strong>Performance Metrics Used:</strong> - <strong>Accuracy</strong> - <strong>Precision</strong> -
<strong>Recall</strong> - <strong>AUC (Area Under the ROC Curve)</strong></p>
<p>We evaluate both baseline and pre-processing fairness mitigation methods
(Reweighing, Disparate Impact Remover, LFR) using these metrics. The
results show that while some approaches can improve fairness (as
measured by DPR, EOR, and SPD), there may be trade-offs with performance
metrics. Additionally, the variance in fairness metrics highlights the
impact of data imbalance, especially for under-represented groups.</p>
<section id="utility-functions">
<h4>Utility functions<a class="headerlink" href="#utility-functions" title="Link to this heading">¶</a></h4>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">train_classifier</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train a logistic regression classifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clf</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">prepare_set</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">X_with_target</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_with_target</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_with_target</span><span class="p">)</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dataset</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_mean_spd</span><span class="p">(</span><span class="n">spd_values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute the mean absolute Statistical Parity Difference (SPD) across all folds and groups.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mean_spd_values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="n">spd_values</span><span class="p">:</span>
        <span class="n">all_spds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fold_dict</span> <span class="ow">in</span> <span class="n">spd_values</span><span class="p">[</span><span class="n">approach</span><span class="p">]:</span>
            <span class="n">all_spds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fold_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">mean_spd_values</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_spds</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Approach&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">mean_spd_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="s1">&#39;Mean |SPD|&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">mean_spd_values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">results</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_spd_results</span><span class="p">(</span><span class="n">spd_results</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">spd_results</span><span class="p">[</span><span class="s1">&#39;Approach&#39;</span><span class="p">],</span> <span class="n">spd_results</span><span class="p">[</span><span class="s1">&#39;Mean |SPD|&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> Absolute SPD across folds and groups&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> |SPD|&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">print_mean_values</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Print the performance or fairness values for each approach &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== </span><span class="si">{</span><span class="n">approach</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="n">approach</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics_dict</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute mean and standard deviation for each metric across all approaches.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">metrics_list</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
        <span class="n">means</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="c1"># Store both</span>
        <span class="n">values</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">means</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">stds</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">values</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_metrics</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">preprocess_approaches</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Performance&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the performance or fairness metrics for each approach.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Baseline&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">preprocess_approaches</span><span class="p">:</span>
        <span class="n">means</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">approach</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">approach</span><span class="p">][</span><span class="s2">&quot;std&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;Performance&quot;</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;Fairness&quot;</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Label must be either &#39;Performance&#39; or &#39;Fairness&#39;.&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="p">[</span><span class="n">means</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="p">[</span><span class="n">stds</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">],</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> Metrics - </span><span class="si">{</span><span class="n">approach</span><span class="si">}</span><span class="s2"> (Mean ± Std across folds)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Metric Value&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="naive-train-test-split">
<h4>Naive Train-Test split<a class="headerlink" href="#naive-train-test-split" title="Link to this heading">¶</a></h4>
<p>Firstly, we only consider one fold:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">preprocess_approaches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Reweighing&#39;</span><span class="p">,</span> <span class="s1">&#39;DIR&#39;</span><span class="p">,</span> <span class="s1">&#39;LRF&#39;</span><span class="p">]</span>

<span class="n">performance_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">approach</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">preprocess_approaches</span><span class="p">}</span>
<span class="n">fairness_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">approach</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">preprocess_approaches</span><span class="p">}</span>
<span class="n">spd_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">approach</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">preprocess_approaches</span><span class="p">}</span>

<span class="c1"># Split into training and testing sets</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># ==========================</span>
<span class="c1"># BASELINE</span>
<span class="c1"># ==========================</span>
<span class="n">baseline</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
<span class="n">baseline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_proba</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">performance_metrics</span><span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">fairness_metrics</span><span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">spd_values</span><span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># ==========================</span>
<span class="c1"># PREPROCESSING METHODS</span>
<span class="c1"># ==========================</span>
<span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="n">preprocess_approaches</span><span class="p">:</span>

    <span class="c1"># Wrap train/test into your special DataFrame class</span>
    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">prepare_set</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">prepare_set</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;Reweighing&#39;</span><span class="p">:</span>
        <span class="n">reweighing</span> <span class="o">=</span> <span class="n">Reweighing</span><span class="p">()</span>
        <span class="n">reweighed_df</span> <span class="o">=</span> <span class="n">reweighing</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">reweighed_df</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">X_train_reweighed</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_reweighed</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">performance_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fairness_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">spd_values</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;DIR&#39;</span><span class="p">:</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="n">DisparateImpactRemover</span><span class="p">(</span><span class="n">repair_level</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="n">X_train_repaired</span> <span class="o">=</span> <span class="nb">dir</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
        <span class="n">X_test_repaired</span> <span class="o">=</span> <span class="nb">dir</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>

        <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_repaired</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_repaired</span><span class="p">)</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_repaired</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">performance_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fairness_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">X_test_repaired</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">spd_values</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;LRF&#39;</span><span class="p">:</span>
        <span class="n">lfr</span> <span class="o">=</span> <span class="n">LFR</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">latent_dim</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">output_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">alpha_z</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">alpha_x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">alpha_y</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="p">)</span>

        <span class="n">lfr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">X_train_transformed</span> <span class="o">=</span> <span class="n">lfr</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
        <span class="n">X_test_transformed</span> <span class="o">=</span> <span class="n">lfr</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>

        <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_transformed</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_transformed</span><span class="p">)</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_transformed</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">performance_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fairness_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">spd_values</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>
</div>
<section id="fairness-metrics">
<h5>Fairness metrics<a class="headerlink" href="#fairness-metrics" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spd_results</span> <span class="o">=</span> <span class="n">compute_mean_spd</span><span class="p">(</span><span class="n">spd_values</span><span class="p">)</span>
<span class="n">plot_spd_results</span><span class="p">(</span><span class="n">spd_results</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_139_0.png" src="_images/main_139_0.png" />
<p>Plot DPR and EOR</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fairness_values</span> <span class="o">=</span> <span class="n">compute_metrics_dict</span><span class="p">(</span><span class="n">fairness_metrics</span><span class="p">)</span>
<span class="n">print_mean_values</span><span class="p">(</span><span class="n">fairness_values</span><span class="p">)</span> <span class="c1"># Print the fairness values for each approach</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===</span> <span class="n">Baseline</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.8358</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.7838</span>

<span class="o">===</span> <span class="n">Reweighing</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.8411</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.7871</span>

<span class="o">===</span> <span class="n">DIR</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.8697</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.8378</span>

<span class="o">===</span> <span class="n">LRF</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.8182</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.6667</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metrics</span><span class="p">(</span><span class="n">fairness_values</span><span class="p">,</span> <span class="n">preprocess_approaches</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fairness&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_142_0.png" src="_images/main_142_0.png" />
<img alt="_images/main_142_1.png" src="_images/main_142_1.png" />
<img alt="_images/main_142_2.png" src="_images/main_142_2.png" />
<img alt="_images/main_142_3.png" src="_images/main_142_3.png" />
</section>
<section id="performance-metrics">
<h5>Performance metrics<a class="headerlink" href="#performance-metrics" title="Link to this heading">¶</a></h5>
<p>Our chosen metrics: Accuracy, Precision, Recall, AUC</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performance_values</span> <span class="o">=</span> <span class="n">compute_metrics_dict</span><span class="p">(</span><span class="n">performance_metrics</span><span class="p">)</span>
<span class="n">print_mean_values</span><span class="p">(</span><span class="n">performance_values</span><span class="p">)</span> <span class="c1"># Print the performance values for each approach</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===</span> <span class="n">Baseline</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6244</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6382</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.8934</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.6117</span>

<span class="o">===</span> <span class="n">Reweighing</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6232</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6376</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.8921</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.6112</span>

<span class="o">===</span> <span class="n">DIR</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6138</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6276</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.9093</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.5957</span>

<span class="o">===</span> <span class="n">LRF</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6162</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6166</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.9879</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.5337</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metrics</span><span class="p">(</span><span class="n">performance_values</span><span class="p">,</span> <span class="n">preprocess_approaches</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Performance&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_145_0.png" src="_images/main_145_0.png" />
<img alt="_images/main_145_1.png" src="_images/main_145_1.png" />
<img alt="_images/main_145_2.png" src="_images/main_145_2.png" />
<img alt="_images/main_145_3.png" src="_images/main_145_3.png" />
</section>
</section>
<section id="stratified-k-fold-cross-validation">
<h4>Stratified K-fold cross-validation<a class="headerlink" href="#stratified-k-fold-cross-validation" title="Link to this heading">¶</a></h4>
<p>We test two different splitting protocols, which, as we will see,
significantly impact the results:</p>
<ol class="arabic simple">
<li><p>Stratification based on the <em>target</em> feature only</p></li>
<li><p>Stratification based on the <em>target + sensitive</em> feature combination</p></li>
</ol>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">skf_cross_validation</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">sensitive_feature</span><span class="p">,</span> <span class="n">split_type</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Perform Stratified K-Fold Cross-Validation on the dataset.</span>
<span class="sd">    Args:</span>
<span class="sd">        df1 (pd.DataFrame): The input DataFrame containing the dataset.</span>
<span class="sd">        target (str): The target variable for classification.</span>
<span class="sd">        sensitive_feature (str): The sensitive feature to be considered for fairness metrics.</span>
<span class="sd">    Returns:</span>
<span class="sd">        performance_metrics (dict): A dictionary containing performance metrics for each approach.</span>
<span class="sd">        fairness_metrics (dict): A dictionary containing fairness metrics for each approach.</span>
<span class="sd">        spd_values (dict): A dictionary containing SPD values for each approach.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

    <span class="n">preprocess_approaches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Reweighing&#39;</span><span class="p">,</span> <span class="s1">&#39;DIR&#39;</span><span class="p">,</span> <span class="s1">&#39;LRF&#39;</span><span class="p">]</span>

    <span class="n">performance_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">approach</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">preprocess_approaches</span><span class="p">}</span>
    <span class="n">fairness_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">approach</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">preprocess_approaches</span><span class="p">}</span>
    <span class="n">spd_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">approach</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">preprocess_approaches</span><span class="p">}</span>

    <span class="n">kf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="n">x_split</span> <span class="o">=</span> <span class="n">df1</span>
    <span class="k">if</span> <span class="n">split_type</span> <span class="o">==</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span>
        <span class="n">y_split</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">split_type</span> <span class="o">==</span> <span class="s1">&#39;target+sensitive&#39;</span><span class="p">:</span>
        <span class="n">y_split</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x_split</span><span class="p">,</span> <span class="n">y_split</span><span class="p">)):</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># ==========================</span>
        <span class="c1"># BASELINE</span>
        <span class="c1"># ==========================</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
        <span class="n">baseline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">performance_metrics</span><span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fairness_metrics</span><span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">spd_values</span><span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># ==========================</span>
        <span class="c1"># PREPROCESSING METHODS</span>
        <span class="c1"># ==========================</span>
        <span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="n">preprocess_approaches</span><span class="p">:</span>

            <span class="c1"># Wrap train/test into your special DataFrame class</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">prepare_set</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">prepare_set</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;Reweighing&#39;</span><span class="p">:</span>
                <span class="n">reweighing</span> <span class="o">=</span> <span class="n">Reweighing</span><span class="p">()</span>
                <span class="n">reweighed_df</span> <span class="o">=</span> <span class="n">reweighing</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">reweighed_df</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">X_train_reweighed</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_reweighed</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
                <span class="n">y_proba</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

                <span class="n">performance_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">fairness_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">spd_values</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;DIR&#39;</span><span class="p">:</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="n">DisparateImpactRemover</span><span class="p">(</span><span class="n">repair_level</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
                <span class="n">X_train_repaired</span> <span class="o">=</span> <span class="nb">dir</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
                <span class="n">X_test_repaired</span> <span class="o">=</span> <span class="nb">dir</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>

                <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_repaired</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_repaired</span><span class="p">)</span>
                <span class="n">y_proba</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_repaired</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

                <span class="n">performance_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">fairness_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">X_test_repaired</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">spd_values</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;LRF&#39;</span><span class="p">:</span>
                <span class="n">lfr</span> <span class="o">=</span> <span class="n">LFR</span><span class="p">(</span>
                    <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">latent_dim</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                    <span class="n">output_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">alpha_z</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">alpha_x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">alpha_y</span><span class="o">=</span><span class="mf">1.0</span>
                <span class="p">)</span>

                <span class="n">lfr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
                <span class="n">X_train_transformed</span> <span class="o">=</span> <span class="n">lfr</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
                <span class="n">X_test_transformed</span> <span class="o">=</span> <span class="n">lfr</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>

                <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_transformed</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_transformed</span><span class="p">)</span>
                <span class="n">y_proba</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_transformed</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

                <span class="n">performance_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">fairness_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">spd_values</span><span class="p">[</span><span class="n">approach</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">performance_metrics</span><span class="p">,</span> <span class="n">fairness_metrics</span><span class="p">,</span> <span class="n">spd_values</span>
</pre></div>
</div>
<section id="splitting-on-target-feature">
<h5>1) Splitting on “target” feature<a class="headerlink" href="#splitting-on-target-feature" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performance_metrics</span><span class="p">,</span> <span class="n">fairness_metrics</span><span class="p">,</span> <span class="n">spd_values</span> <span class="o">=</span> <span class="n">skf_cross_validation</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">sensitive_feature</span><span class="p">,</span> <span class="n">split_type</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>1.1) Fairness metrics</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spd_results</span> <span class="o">=</span> <span class="n">compute_mean_spd</span><span class="p">(</span><span class="n">spd_values</span><span class="p">)</span>
<span class="n">plot_spd_results</span><span class="p">(</span><span class="n">spd_results</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_151_0.png" src="_images/main_151_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fairness_values</span> <span class="o">=</span> <span class="n">compute_metrics_dict</span><span class="p">(</span><span class="n">fairness_metrics</span><span class="p">)</span>
<span class="n">print_mean_values</span><span class="p">(</span><span class="n">fairness_values</span><span class="p">)</span> <span class="c1"># Print the fairness values for each approach</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===</span> <span class="n">Baseline</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.7746</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.1518</span>

<span class="o">===</span> <span class="n">Reweighing</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.7620</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.1429</span>

<span class="o">===</span> <span class="n">DIR</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.7794</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.1429</span>

<span class="o">===</span> <span class="n">LRF</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.8673</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.3285</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metrics</span><span class="p">(</span><span class="n">fairness_values</span><span class="p">,</span> <span class="n">preprocess_approaches</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fairness&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_153_0.png" src="_images/main_153_0.png" />
<img alt="_images/main_153_1.png" src="_images/main_153_1.png" />
<img alt="_images/main_153_2.png" src="_images/main_153_2.png" />
<img alt="_images/main_153_3.png" src="_images/main_153_3.png" />
<p>We spot a really high variance. Why is that? Let’s inspect the
metrics for each fold.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="n">fairness_metrics</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== </span><span class="si">{</span><span class="n">approach</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fairness_metrics</span><span class="p">[</span><span class="n">approach</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Fold </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> === Baseline ===
   Fold 1: {&#39;dpr&#39;: np.float64(0.7767857142857143), &#39;eor&#39;: 0.7589285714285715}
   Fold 2: {&#39;dpr&#39;: np.float64(0.8586326767091541), &#39;eor&#39;: 0.0}
   Fold 3: {&#39;dpr&#39;: np.float64(0.8579083837510804), &#39;eor&#39;: 0.0}
   Fold 4: {&#39;dpr&#39;: np.float64(0.5344827586206897), &#39;eor&#39;: 0.0}
   Fold 5: {&#39;dpr&#39;: np.float64(0.8451025056947609), &#39;eor&#39;: 0.0}

 === Reweighing ===
   Fold 1: {&#39;dpr&#39;: np.float64(0.75), &#39;eor&#39;: 0.7142857142857143}
   Fold 2: {&#39;dpr&#39;: np.float64(0.8586326767091541), &#39;eor&#39;: 0.0}
   Fold 3: {&#39;dpr&#39;: np.float64(0.8067415730337079), &#39;eor&#39;: 0.0}
   Fold 4: {&#39;dpr&#39;: np.float64(0.5462962962962963), &#39;eor&#39;: 0.0}
   Fold 5: {&#39;dpr&#39;: np.float64(0.8485193621867881), &#39;eor&#39;: 0.0}

 === DIR ===
   Fold 1: {&#39;dpr&#39;: np.float64(0.75), &#39;eor&#39;: 0.7142857142857143}
   Fold 2: {&#39;dpr&#39;: np.float64(0.8922363847045192), &#39;eor&#39;: 0.0}
   Fold 3: {&#39;dpr&#39;: np.float64(0.8680555555555556), &#39;eor&#39;: 0.0}
   Fold 4: {&#39;dpr&#39;: np.float64(0.5086206896551724), &#39;eor&#39;: 0.0}
   Fold 5: {&#39;dpr&#39;: np.float64(0.878132118451025), &#39;eor&#39;: 0.0}

 === LRF ===
   Fold 1: {&#39;dpr&#39;: np.float64(0.75), &#39;eor&#39;: 0.7142857142857143}
   Fold 2: {&#39;dpr&#39;: np.float64(0.8846153846153846), &#39;eor&#39;: 0.0}
   Fold 3: {&#39;dpr&#39;: np.float64(0.9066666666666666), &#39;eor&#39;: 0.0}
   Fold 4: {&#39;dpr&#39;: np.float64(0.946236559139785), &#39;eor&#39;: 0.9279661016949152}
   Fold 5: {&#39;dpr&#39;: np.float64(0.8491811938721606), &#39;eor&#39;: 0.0}



From the code above, we see that most folds output an EOR of 0. This
occurs because the “Hired South Females” group is heavily
under-represented, resulting in too few examples for this class in
each fold. As a result, EOR metric cannot be computed reliably across
all folds. This also explains the extremely high variance. &gt; A more
exhaustive explanation will be given in the next sections.
</pre></div>
</div>
<p>1.2) Performance metrics</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performance_values</span> <span class="o">=</span> <span class="n">compute_metrics_dict</span><span class="p">(</span><span class="n">performance_metrics</span><span class="p">)</span>
<span class="n">print_mean_values</span><span class="p">(</span><span class="n">performance_values</span><span class="p">)</span> <span class="c1"># Print the fairness values for each approach</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===</span> <span class="n">Baseline</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6185</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6336</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.8904</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.6123</span>

<span class="o">===</span> <span class="n">Reweighing</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6192</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6340</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.8910</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.6124</span>

<span class="o">===</span> <span class="n">DIR</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6170</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6257</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.9293</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.5990</span>

<span class="o">===</span> <span class="n">LRF</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6195</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6229</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.9554</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.5958</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metrics</span><span class="p">(</span><span class="n">performance_values</span><span class="p">,</span> <span class="n">preprocess_approaches</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Performance&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_159_0.png" src="_images/main_159_0.png" />
<img alt="_images/main_159_1.png" src="_images/main_159_1.png" />
<img alt="_images/main_159_2.png" src="_images/main_159_2.png" />
<img alt="_images/main_159_3.png" src="_images/main_159_3.png" />
</section>
<section id="splitting-on-target-sensitive-feature">
<h5>2) Splitting on “target + sensitive” feature<a class="headerlink" href="#splitting-on-target-sensitive-feature" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performance_metrics</span><span class="p">,</span> <span class="n">fairness_metrics</span><span class="p">,</span> <span class="n">spd_values</span> <span class="o">=</span> <span class="n">skf_cross_validation</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">sensitive_feature</span><span class="p">,</span> <span class="n">split_type</span><span class="o">=</span><span class="s1">&#39;target+sensitive&#39;</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">c:UsersfolloAppDataLocalProgramsPythonPython311Libsite-packagessklearnmodel_selection_split.py:811: UserWarning: The least populated class in y has only 2 members, which is less than n_splits=5.
  warnings.warn(</pre>
<p>2.1) Fairness metrics</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spd_results</span> <span class="o">=</span> <span class="n">compute_mean_spd</span><span class="p">(</span><span class="n">spd_values</span><span class="p">)</span>
<span class="n">plot_spd_results</span><span class="p">(</span><span class="n">spd_results</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_163_0.png" src="_images/main_163_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fairness_values</span> <span class="o">=</span> <span class="n">compute_metrics_dict</span><span class="p">(</span><span class="n">fairness_metrics</span><span class="p">)</span>
<span class="n">print_mean_values</span><span class="p">(</span><span class="n">fairness_values</span><span class="p">)</span> <span class="c1"># Print the fairness values for each approach</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===</span> <span class="n">Baseline</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.8156</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.2787</span>

<span class="o">===</span> <span class="n">Reweighing</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.8266</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.3099</span>

<span class="o">===</span> <span class="n">DIR</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.8547</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.3382</span>

<span class="o">===</span> <span class="n">LRF</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.6389</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.2591</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metrics</span><span class="p">(</span><span class="n">fairness_values</span><span class="p">,</span> <span class="n">preprocess_approaches</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fairness&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_165_0.png" src="_images/main_165_0.png" />
<img alt="_images/main_165_1.png" src="_images/main_165_1.png" />
<img alt="_images/main_165_2.png" src="_images/main_165_2.png" />
<img alt="_images/main_165_3.png" src="_images/main_165_3.png" />
<p>We can clearly see that the second protocol leads to better fairness
metrics. Specifically, SPD is lower, while EOR and DPR are higher.
This is because stratifying on the target + sensitive combination
ensures a slightly more balanced representation of all groups and
labels in each fold, making the evaluation of fairness metrics more
reliable and stable.</p>
<p>2.2) Performance metrics</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performance_values</span> <span class="o">=</span> <span class="n">compute_metrics_dict</span><span class="p">(</span><span class="n">performance_metrics</span><span class="p">)</span>
<span class="n">print_mean_values</span><span class="p">(</span><span class="n">performance_values</span><span class="p">)</span> <span class="c1"># Print the fairness values for each approach</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===</span> <span class="n">Baseline</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6185</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6334</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.8908</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.6117</span>

<span class="o">===</span> <span class="n">Reweighing</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6190</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6337</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.8912</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.6116</span>

<span class="o">===</span> <span class="n">DIR</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6127</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6246</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.9164</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.5997</span>

<span class="o">===</span> <span class="n">LRF</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6182</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6217</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.9575</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.5889</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metrics</span><span class="p">(</span><span class="n">performance_values</span><span class="p">,</span> <span class="n">preprocess_approaches</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Performance&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_169_0.png" src="_images/main_169_0.png" />
<img alt="_images/main_169_1.png" src="_images/main_169_1.png" />
<img alt="_images/main_169_2.png" src="_images/main_169_2.png" />
<img alt="_images/main_169_3.png" src="_images/main_169_3.png" />
</section>
</section>
<section id="data-rebalancing-checking-the-robustness-of-our-pipeline">
<h4>Data rebalancing: checking the robustness of our pipeline<a class="headerlink" href="#data-rebalancing-checking-the-robustness-of-our-pipeline" title="Link to this heading">¶</a></h4>
<p>The dataset is imbalanced, which prevents us from obtaining meaningful
results even when following a correct pipeline. To ensure that each fold
contains at least one example from underrepresented (unfair) groups, we
artificially augment the data. This allows us to test whether our
approach remains valid and robust under these conditions.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">sensitive_feature</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hired</span>  <span class="n">grouped_regions</span>
<span class="mi">0</span>      <span class="mf">0.0</span>                 <span class="mi">152</span>
       <span class="mf">1.0</span>                 <span class="mi">155</span>
       <span class="mf">2.0</span>                <span class="mi">1235</span>
       <span class="mf">3.0</span>                <span class="mi">1705</span>
       <span class="mf">4.0</span>                  <span class="mi">31</span>
       <span class="mf">5.0</span>                  <span class="mi">39</span>
<span class="mi">1</span>      <span class="mf">0.0</span>                 <span class="mi">272</span>
       <span class="mf">1.0</span>                 <span class="mi">141</span>
       <span class="mf">2.0</span>                <span class="mi">2100</span>
       <span class="mf">3.0</span>                <span class="mi">2645</span>
       <span class="mf">4.0</span>                   <span class="mi">2</span>
       <span class="mf">5.0</span>                  <span class="mi">43</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sampling under-represented classes</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[(</span><span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">df1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df1</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.03.0</span>    <span class="mi">2645</span>
<span class="mf">1.02.0</span>    <span class="mi">2100</span>
<span class="mf">0.03.0</span>    <span class="mi">1705</span>
<span class="mf">0.02.0</span>    <span class="mi">1235</span>
<span class="mf">1.00.0</span>     <span class="mi">272</span>
<span class="mf">0.01.0</span>     <span class="mi">155</span>
<span class="mf">0.00.0</span>     <span class="mi">152</span>
<span class="mf">1.01.0</span>     <span class="mi">141</span>
<span class="mf">1.05.0</span>      <span class="mi">43</span>
<span class="mf">0.05.0</span>      <span class="mi">39</span>
<span class="mf">0.04.0</span>      <span class="mi">31</span>
<span class="mf">1.04.0</span>       <span class="mi">8</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">sensitive_feature</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hired</span>  <span class="n">grouped_regions</span>
<span class="mi">0</span>      <span class="mf">0.0</span>                 <span class="mi">152</span>
       <span class="mf">1.0</span>                 <span class="mi">155</span>
       <span class="mf">2.0</span>                <span class="mi">1235</span>
       <span class="mf">3.0</span>                <span class="mi">1705</span>
       <span class="mf">4.0</span>                  <span class="mi">31</span>
       <span class="mf">5.0</span>                  <span class="mi">39</span>
<span class="mi">1</span>      <span class="mf">0.0</span>                 <span class="mi">272</span>
       <span class="mf">1.0</span>                 <span class="mi">141</span>
       <span class="mf">2.0</span>                <span class="mi">2100</span>
       <span class="mf">3.0</span>                <span class="mi">2645</span>
       <span class="mf">4.0</span>                   <span class="mi">2</span>
       <span class="mf">5.0</span>                  <span class="mi">43</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<p>As we can see, the number of examples for “hired south females” has
increased to 8. This makes the k-fold split feasible, and we can now
expect more reliable results. We will perform the split using the
“target + sensitive” feature combination.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performance_metrics</span><span class="p">,</span> <span class="n">fairness_metrics</span><span class="p">,</span> <span class="n">spd_values</span> <span class="o">=</span> <span class="n">skf_cross_validation</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">sensitive_feature</span><span class="p">,</span> <span class="n">split_type</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
</pre></div>
</div>
<section id="id1">
<h5>Fairness metrics<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spd_results</span> <span class="o">=</span> <span class="n">compute_mean_spd</span><span class="p">(</span><span class="n">spd_values</span><span class="p">)</span>
<span class="n">plot_spd_results</span><span class="p">(</span><span class="n">spd_results</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_177_0.png" src="_images/main_177_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fairness_values</span> <span class="o">=</span> <span class="n">compute_metrics_dict</span><span class="p">(</span><span class="n">fairness_metrics</span><span class="p">)</span>
<span class="n">print_mean_values</span><span class="p">(</span><span class="n">fairness_values</span><span class="p">)</span> <span class="c1"># Print the fairness values for each approach</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===</span> <span class="n">Baseline</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.7957</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.5959</span>

<span class="o">===</span> <span class="n">Reweighing</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.7932</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.5983</span>

<span class="o">===</span> <span class="n">DIR</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.8381</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.6207</span>

<span class="o">===</span> <span class="n">LRF</span> <span class="o">===</span>
  <span class="n">dpr</span><span class="p">:</span> <span class="mf">0.8931</span>
  <span class="n">eor</span><span class="p">:</span> <span class="mf">0.6129</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metrics</span><span class="p">(</span><span class="n">fairness_values</span><span class="p">,</span> <span class="n">preprocess_approaches</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fairness&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_179_0.png" src="_images/main_179_0.png" />
<img alt="_images/main_179_1.png" src="_images/main_179_1.png" />
<img alt="_images/main_179_2.png" src="_images/main_179_2.png" />
<img alt="_images/main_179_3.png" src="_images/main_179_3.png" />
</section>
<section id="id2">
<h5>Performance metrics<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performance_values</span> <span class="o">=</span> <span class="n">compute_metrics_dict</span><span class="p">(</span><span class="n">performance_metrics</span><span class="p">)</span>
<span class="n">print_mean_values</span><span class="p">(</span><span class="n">performance_values</span><span class="p">)</span> <span class="c1"># Print the fairness values for each approach</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===</span> <span class="n">Baseline</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6188</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6335</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.8921</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.6130</span>

<span class="o">===</span> <span class="n">Reweighing</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6194</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6337</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.8935</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.6131</span>

<span class="o">===</span> <span class="n">DIR</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6158</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6250</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.9292</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.5987</span>

<span class="o">===</span> <span class="n">LRF</span> <span class="o">===</span>
  <span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.6141</span>
  <span class="n">precision</span><span class="p">:</span> <span class="mf">0.6159</span>
  <span class="n">recall</span><span class="p">:</span> <span class="mf">0.9798</span>
  <span class="n">auc</span><span class="p">:</span> <span class="mf">0.5981</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metrics</span><span class="p">(</span><span class="n">performance_values</span><span class="p">,</span> <span class="n">preprocess_approaches</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Performance&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_182_0.png" src="_images/main_182_0.png" />
<img alt="_images/main_182_1.png" src="_images/main_182_1.png" />
<img alt="_images/main_182_2.png" src="_images/main_182_2.png" />
<img alt="_images/main_182_3.png" src="_images/main_182_3.png" />
</section>
<section id="id3">
<h5>Considerations<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h5>
<p>As expected, we obtain slightly better results for the fairness metrics.
The improvement is especially noticeable for DPR and EOR, which now show
reasonable variance and effectively increase compared to the baseline.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="c1"># Split into training and testing sets</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">,</span> <span class="s1">&#39;cand_domicile_province&#39;</span><span class="p">,</span> <span class="s1">&#39;cand_education&#39;</span><span class="p">,</span> <span class="s1">&#39;job_professional_category&#39;</span><span class="p">,</span> <span class="s1">&#39;job_sector&#39;</span><span class="p">,</span> <span class="s1">&#39;job_work_province&#39;</span><span class="p">]</span>
<span class="n">X_train</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
<span class="n">X_test</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training set shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Training</span> <span class="nb">set</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">5964</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">Testing</span> <span class="nb">set</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">2556</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_dataframe</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="n">X_train_dataframe</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

<span class="n">baseline_model</span> <span class="o">=</span> <span class="n">AdversarialDebiasing</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sensitive_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">lambda_adv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">baseline_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">X_test_dataframe</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="n">X_test_dataframe</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

<span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">baseline_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_pred</span>
<span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
<span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>

<span class="c1"># Fairness metrics</span>
<span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
<span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>

<span class="c1"># SPD aggiuntivo (usando metodo fairlib)</span>
<span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
<span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Baseline SPD (AdversarialDebiasing λ=0): </span><span class="si">{</span><span class="n">spd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Baseline</span> <span class="n">SPD</span> <span class="p">(</span><span class="n">AdversarialDebiasing</span> <span class="n">λ</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0646026772453311</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.051445249976461715</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06738347917830323</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.07855362819355599</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.03485960881017766</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.141780871062639</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.06460267724533109</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.051445249976461715</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.06738347917830323</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.07855362819355605</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.03485960881017758</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.14178087106263904</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adv_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">adv_spds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">lam</span> <span class="ow">in</span> <span class="n">adv_weights</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== Adversarial Debiasing con lambda_adv=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Prepara fairlib dataframe</span>
    <span class="n">X_tr</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">X_tr</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

    <span class="n">X_te</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">X_te</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

    <span class="c1"># Modello Adversarial Debiasing</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AdversarialDebiasing</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">sensitive_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">lambda_adv</span><span class="o">=</span><span class="n">lam</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Addestramento</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Predizione</span>
    <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_pred</span>

    <span class="c1"># Performance</span>
    <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
    <span class="n">inprocessing_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>

    <span class="c1"># Fairness</span>
    <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
    <span class="n">inprocessing_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>

    <span class="c1"># SPD extra</span>
    <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
    <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
    <span class="n">adv_spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPD (λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">spd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">==</span>
<span class="n">SPD</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.00041203131437989287</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0004048582995951417</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0006361323155216285</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0007530120481927711</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.00039231071008238524</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0003946329913180742</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0004120313143799459</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0004048582995951344</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0006361323155216203</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0007530120481927804</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0003923107100823886</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.00039463299131803353</span><span class="p">}</span>

<span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">==</span>
<span class="n">SPD</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.01295503109399105</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.011336032388663968</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.00697418233724322</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.007127859974098347</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.010984699882306787</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.011049723756906077</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.012955031093991098</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.011336032388663986</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.006974182337243229</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.007127859974098372</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.01098469988230677</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.011049723756906049</span><span class="p">}</span>

<span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">==</span>
<span class="n">SPD</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="in-processing">
<h3>In-Processing<a class="headerlink" href="#in-processing" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sensitive_feature</span> <span class="o">=</span> <span class="s1">&#39;grouped_regions&#39;</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_performance_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;dpr&#39;</span><span class="p">:</span> <span class="n">demographic_parity_ratio</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="o">=</span><span class="n">sensitive_features</span><span class="p">),</span>
        <span class="s1">&#39;eor&#39;</span><span class="p">:</span> <span class="n">equalized_odds_ratio</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="o">=</span><span class="n">sensitive_features</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">X_test_copy</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_test_copy</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_copy</span><span class="p">)</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

    <span class="n">spd</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">statistical_parity_difference</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">spd</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">metrics_bar_plot</span><span class="p">(</span><span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">,</span> <span class="n">label1</span><span class="p">,</span> <span class="n">label2</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Metric Comparison (mean ± std)&quot;</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="n">metric_dict</span><span class="p">):</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">mean_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">std_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_val</span><span class="p">)</span>
            <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stds</span><span class="p">)</span>

    <span class="n">mean1</span><span class="p">,</span> <span class="n">std1</span> <span class="o">=</span> <span class="n">summarise</span><span class="p">(</span><span class="n">dict1</span><span class="p">)</span>
    <span class="n">mean2</span><span class="p">,</span> <span class="n">std2</span> <span class="o">=</span> <span class="n">summarise</span><span class="p">(</span><span class="n">dict2</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">[</span><span class="n">mean1</span><span class="p">,</span> <span class="n">mean2</span><span class="p">],</span> <span class="p">[</span><span class="n">std1</span><span class="p">,</span> <span class="n">std2</span><span class="p">],</span> <span class="p">[</span><span class="n">label1</span><span class="p">,</span> <span class="n">label2</span><span class="p">]):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Simple_NN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">return_representation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Simple_NN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_representation</span> <span class="o">=</span> <span class="n">return_representation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">input_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn3</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_representation</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">rep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_metrics</span><span class="p">(</span><span class="n">metric_list</span><span class="p">):</span>
    <span class="n">metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">fold_metrics</span> <span class="ow">in</span> <span class="n">metric_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fold_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics_dict</span><span class="p">:</span>
                <span class="n">metrics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">metrics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metrics_dict</span>
</pre></div>
</div>
<section id="adversarial-debiasing">
<h4>1) Adversarial Debiasing<a class="headerlink" href="#adversarial-debiasing" title="Link to this heading">¶</a></h4>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
</pre></div>
</div>
<section id="baseline">
<h5>Baseline<a class="headerlink" href="#baseline" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fairlib.inprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdversarialDebiasing</span>

<span class="n">k</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Suddivisione in training e test set</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
    <span class="n">sensitive_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">][</span><span class="n">sensitive_feature</span><span class="p">]</span>
    <span class="n">sensitive_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">][</span><span class="n">sensitive_feature</span><span class="p">]</span>

    <span class="c1"># Aggiungi la colonna &#39;sensitive&#39; per fairlib</span>
    <span class="n">X_train_copy</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_train_copy</span><span class="p">[</span><span class="s2">&quot;sensitive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitive_train</span><span class="o">.</span><span class="n">values</span>
    <span class="n">X_train_dataframe</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_copy</span><span class="p">)</span>
    <span class="n">X_train_dataframe</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="s2">&quot;sensitive&quot;</span>

    <span class="n">X_test_copy</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_test_copy</span><span class="p">[</span><span class="s2">&quot;sensitive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitive_test</span><span class="o">.</span><span class="n">values</span>
    <span class="n">X_test_dataframe</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_copy</span><span class="p">)</span>
    <span class="n">X_test_dataframe</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="s2">&quot;sensitive&quot;</span>

    <span class="c1"># Modello AdversarialDebiasing</span>
    <span class="n">baseline_model</span> <span class="o">=</span> <span class="n">AdversarialDebiasing</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">sensitive_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">lambda_adv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="n">baseline_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Prediction</span>
    <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">baseline_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_pred</span>

    <span class="c1"># Performance metrics</span>
    <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
    <span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>

    <span class="c1"># Fairness metrics</span>
    <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">sensitive_test</span><span class="p">)</span>
    <span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>

    <span class="c1"># SPD evaluation</span>
    <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
    <span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPD Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">spd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">1</span><span class="p">:</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.04162708833882772</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.11578748900155028</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09149740728688097</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.06439560923999296</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.14268867924528303</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.033175914994096806</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04162708833882767</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.11578748900155023</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.09149740728688105</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06439560923999299</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.14268867924528306</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.03317591499409689</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">2</span><span class="p">:</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.1717296962182269</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.16686746987951806</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.060912891835098903</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.08619242941760828</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.4768834237233528</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.18643990098102137</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.17172969621822687</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.16686746987951806</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.06091289183509885</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0861924294176083</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.4768834237233528</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.18643990098102137</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">3</span><span class="p">:</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.054364640883977855</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0034969156418215297</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.07514402969126838</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.06661513403086436</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.07891637220259129</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.18478444632290789</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.054364640883977855</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0034969156418215297</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.07514402969126832</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06661513403086439</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.07891637220259129</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.1847844463229079</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">4</span><span class="p">:</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.07785186520093709</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.010221008706403578</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.08846349446451159</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.09856342077588784</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.3407755581668625</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.034952606635071076</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.07785186520093712</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.010221008706403523</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.08846349446451163</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09856342077588787</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.34077555816686256</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.03495260663507105</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">5</span><span class="p">:</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.1203870387038704</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.04790741036258114</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04905140987624282</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.05133833773654631</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.007067137809187274</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.2805094786729858</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.12038703870387046</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04790741036258117</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.04905140987624279</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.05133833773654639</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.007067137809187218</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.2805094786729858</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="with-different-adversary-weights">
<h5>With different adversary weights<a class="headerlink" href="#with-different-adversary-weights" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In-processing con Adversarial Debiasing su diversi lambda_adv</span>
<span class="n">adv_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">adv_spds</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adv_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== Adversarial Debiasing con lambda_adv=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Crea liste per ciascun lambda</span>
    <span class="n">perf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fair_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spd_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> - lambda_adv=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Split dei dati</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">sensitive_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">][</span><span class="n">sensitive_feature</span><span class="p">]</span>
        <span class="n">sensitive_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">][</span><span class="n">sensitive_feature</span><span class="p">]</span>

        <span class="c1"># Prepara fairlib dataframe</span>
        <span class="n">X_train_copy</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X_train_copy</span><span class="p">[</span><span class="s2">&quot;sensitive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitive_train</span><span class="o">.</span><span class="n">values</span>
        <span class="n">X_tr</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_copy</span><span class="p">)</span>
        <span class="n">X_tr</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="s2">&quot;sensitive&quot;</span>

        <span class="n">X_test_copy</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X_test_copy</span><span class="p">[</span><span class="s2">&quot;sensitive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitive_test</span><span class="o">.</span><span class="n">values</span>
        <span class="n">X_te</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_copy</span><span class="p">)</span>
        <span class="n">X_te</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="s2">&quot;sensitive&quot;</span>

        <span class="c1"># Modello Adversarial Debiasing</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">AdversarialDebiasing</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">sensitive_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">lambda_adv</span><span class="o">=</span><span class="n">lam</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Addestramento</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># Predizione</span>
        <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_pred</span>

        <span class="c1"># Performance</span>
        <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
        <span class="n">perf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>

        <span class="c1"># Fairness</span>
        <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">sensitive_test</span><span class="p">)</span>
        <span class="n">fair_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>

        <span class="c1"># SPD</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
        <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="n">spd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPD Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">spd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Salva i risultati complessivi del lambda</span>
    <span class="n">inprocessing_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_list</span><span class="p">)</span>
    <span class="n">inprocessing_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_list</span><span class="p">)</span>
    <span class="n">adv_spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_list</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">==</span>

<span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">1</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.06618826778630098</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.03796036368207148</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.011476432529064107</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.013092928936695461</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.10613207547169812</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.10625737898465171</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06618826778630094</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.03796036368207145</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.011476432529064051</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.013092928936695447</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.10613207547169812</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.10625737898465171</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">2</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06002738736774694</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06883899233296822</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.007551829466432708</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.03172435838260197</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09037212049616067</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.05212249014394425</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.06002738736774693</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.06883899233296831</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.007551829466432625</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.031724358382602014</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.09037212049616061</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.05212249014394432</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">3</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.06448127685696747</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.03406545911751994</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.04503408302913739</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.056930679402589515</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.03180212014134275</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.03195266272189349</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06448127685696747</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.034065459117520014</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04503408302913747</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.05693067940258956</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.03180212014134276</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.031952662721893454</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">4</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.21397248753529166</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.10194219772294061</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.05342061453266743</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.1049172826421039</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0881316098707403</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.08886255924170616</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.21397248753529163</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.10194219772294055</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.05342061453266744</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.10491728264210398</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.08813160987074031</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.08886255924170616</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">5</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.006300630063006296</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0065679514206764475</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.012491516703482593</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.010849001969035946</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0624263839811543</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06279620853080568</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.006300630063006296</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.006567951420676454</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.012491516703482586</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.010849001969035932</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0624263839811543</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0627962085308057</span><span class="p">}</span>

<span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">==</span>

<span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">1</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">2</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.02169869807811531</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.02108433734939759</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.02643356946339984</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.014730298174523239</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.16232615582881382</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.21348675162739528</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.021698698078115308</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.02108433734939763</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.02643356946339981</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.014730298174523204</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.16232615582881382</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.21348675162739517</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">3</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">4</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">5</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0006188118811881188</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0006131207847946045</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0015552099533437014</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0012106537530266344</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0005889281507656066</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0005924170616113745</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0006188118811880639</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0006131207847945852</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0015552099533436836</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.001210653753026647</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0005889281507656108</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0005924170616113944</span><span class="p">}</span>

<span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">==</span>

<span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">1</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">2</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">3</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.003683241252302026</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0036540803897685747</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0017008805327681175</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.00031471716864975297</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0035335689045936395</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0035502958579881655</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0036832412523020164</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0036540803897685548</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0017008805327681786</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0003147171686497252</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0035335689045936647</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0035502958579881616</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">4</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.015518311607697082</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.015197568389057751</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.014139728159053469</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.016959711553967166</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.014688601645123384</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.04828199052132701</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.015518311607697122</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.015197568389057725</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.01413972815905351</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.01695971155396714</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.014688601645123422</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04828199052132698</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">5</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;AdvDebias λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">lam</span> <span class="ow">in</span> <span class="n">adv_weights</span><span class="p">]</span>

<span class="c1"># Calcola la media degli SPD per ogni lambda</span>
<span class="n">mean_adv_spds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spd_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">spd_list</span> <span class="ow">in</span> <span class="n">adv_spds</span><span class="p">]</span>
<span class="n">spds</span> <span class="o">=</span> <span class="p">[</span><span class="n">baseline_spd_val</span><span class="p">]</span> <span class="o">+</span> <span class="n">mean_adv_spds</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">model_names</span><span class="p">,</span>
    <span class="s1">&#39;SPD&#39;</span><span class="p">:</span> <span class="n">spds</span>
<span class="p">})</span>

<span class="c1"># Plot a barre</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SPD&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Statistical Parity Difference (SPD)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;|SPD|&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_202_0.png" src="_images/main_202_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adv_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;== Bar plot per λ = </span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Performance</span>
    <span class="n">inproc_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_performance_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_perf_dict</span><span class="p">,</span>
        <span class="n">base_perf_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (Adversarial λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Fairness</span>
    <span class="n">inproc_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_fairness_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_fair_dict</span><span class="p">,</span>
        <span class="n">base_fair_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (Adversarial λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_203_1.png" src="_images/main_203_1.png" />
<img alt="_images/main_203_2.png" src="_images/main_203_2.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_203_4.png" src="_images/main_203_4.png" />
<img alt="_images/main_203_5.png" src="_images/main_203_5.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_203_7.png" src="_images/main_203_7.png" />
<img alt="_images/main_203_8.png" src="_images/main_203_8.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lambda_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

<span class="n">accuracies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">precisions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">recalls</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">aucs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">metrics_list</span> <span class="ow">in</span> <span class="n">inprocessing_performance_metrics</span><span class="p">:</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
    <span class="n">accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]))</span>
    <span class="n">precisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]))</span>
    <span class="n">recalls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]))</span>
    <span class="n">aucs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">aucs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;lambda_adv&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Metric value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Performance Metrics vs lambda_adv&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_204_0.png" src="_images/main_204_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dprs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">eors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">metrics_list</span> <span class="ow">in</span> <span class="n">inprocessing_fairness_metrics</span><span class="p">:</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
    <span class="n">dprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;dpr&#39;</span><span class="p">]))</span>
    <span class="n">eors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;eor&#39;</span><span class="p">]))</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">dprs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;DPR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">eors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EOR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;lambda_adv&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fairness metric&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fairness Metrics vs lambda_adv&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_205_0.png" src="_images/main_205_0.png" />
</section>
</section>
<section id="fauci">
<h4>2) FaUCI<a class="headerlink" href="#fauci" title="Link to this heading">¶</a></h4>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">reg_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">fauci_spd_vals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reg_weights</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reg_weights</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== FaUCI training with regularization weight: </span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>
    <span class="n">fold_spds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">X_train_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">X_test_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">y_train_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">y_test_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>

        <span class="n">input_dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">X_test_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_test_fold</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">Simple_NN</span><span class="p">(</span><span class="n">input_dim</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

        <span class="n">fauci_model</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">Fauci</span><span class="p">(</span>
            <span class="n">torchModel</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
            <span class="n">loss</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(),</span>
            <span class="n">fairness_regularization</span><span class="o">=</span><span class="s2">&quot;spd&quot;</span><span class="p">,</span>
            <span class="n">regularization_weight</span><span class="o">=</span><span class="n">weight</span>
        <span class="p">)</span>

        <span class="c1"># Prepara dati fairlib</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_fold</span><span class="p">)</span>
        <span class="n">train_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_train_fold</span><span class="o">.</span><span class="n">values</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

        <span class="c1"># Fit</span>
        <span class="n">fauci_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">fauci_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_tensor</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Metrics</span>
        <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test_fold</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test_fold</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">X_test_fold</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test_fold</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
        <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>

        <span class="c1"># Salva</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="n">spd_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="n">fold_spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weight</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">mean_spd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_spds</span><span class="p">)</span>
        <span class="n">fauci_spd_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[λ=</span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2">] Mean SPD: </span><span class="si">{</span><span class="n">mean_spd</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.0</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.1</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0836</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.2</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.2</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0796</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.3</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.3</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0851</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.4</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.4</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0804</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;FaUCI λ=</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">reg_weights</span> <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">spds</span> <span class="o">=</span> <span class="p">[</span><span class="n">baseline_spd_val</span><span class="p">]</span> <span class="o">+</span> <span class="n">fauci_spd_vals</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">model_names</span><span class="p">,</span>
    <span class="s1">&#39;SPD&#39;</span><span class="p">:</span> <span class="n">spds</span>
<span class="p">})</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SPD&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;mediumseagreen&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Statistical Parity Difference (SPD) - FaUCI&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;|SPD|&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_209_0.png" src="_images/main_209_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>  <span class="c1"># Salta λ=0.0 perché è il baseline</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;== Bar plot per λ = </span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Performance metrics</span>
    <span class="n">inproc_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_performance_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_perf_dict</span><span class="p">,</span>
        <span class="n">base_perf_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (FaUCI λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Fairness metrics</span>
    <span class="n">inproc_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_fairness_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_fair_dict</span><span class="p">,</span>
        <span class="n">base_fair_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (FaUCI λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_210_1.png" src="_images/main_210_1.png" />
<img alt="_images/main_210_2.png" src="_images/main_210_2.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_210_4.png" src="_images/main_210_4.png" />
<img alt="_images/main_210_5.png" src="_images/main_210_5.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_210_7.png" src="_images/main_210_7.png" />
<img alt="_images/main_210_8.png" src="_images/main_210_8.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_210_10.png" src="_images/main_210_10.png" />
<img alt="_images/main_210_11.png" src="_images/main_210_11.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fauci_lambdas</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">reg_weights</span> <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>

<span class="n">accuracies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">precisions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">recalls</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">aucs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">metrics_list</span> <span class="ow">in</span> <span class="n">inprocessing_performance_metrics</span><span class="p">:</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
    <span class="n">accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]))</span>
    <span class="n">precisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]))</span>
    <span class="n">recalls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]))</span>
    <span class="n">aucs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]))</span>

<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fauci_lambdas</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fauci_lambdas</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fauci_lambdas</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fauci_lambdas</span><span class="p">,</span> <span class="n">aucs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;λ (FaUCI)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Metric Value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Performance Metrics vs Regularization Weight (FaUCI)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_211_0.png" src="_images/main_211_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fauci_lambdas</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">reg_weights</span> <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>

<span class="n">dprs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">eors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">metrics_list</span> <span class="ow">in</span> <span class="n">inprocessing_fairness_metrics</span><span class="p">:</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
    <span class="n">dprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;dpr&#39;</span><span class="p">]))</span>
    <span class="n">eors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;eor&#39;</span><span class="p">]))</span>

<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fauci_lambdas</span><span class="p">,</span> <span class="n">dprs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;DPR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fauci_lambdas</span><span class="p">,</span> <span class="n">eors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EOR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;λ (FaUCI)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fairness Metric&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fairness Metrics vs Regularization Weight (FaUCI)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_212_0.png" src="_images/main_212_0.png" />
</section>
<section id="prejudice-remover">
<h4>3) Prejudice Remover<a class="headerlink" href="#prejudice-remover" title="Link to this heading">¶</a></h4>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">etas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">pr_spd_vals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">etas</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">etas</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etas</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== PrejudiceRemover training with eta: </span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>
    <span class="n">fold_spds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">X_train_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">X_test_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">y_train_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">y_test_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>

        <span class="n">input_dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">Simple_NN</span><span class="p">(</span><span class="n">input_dim</span><span class="p">)</span>
        <span class="n">pr_model</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">PrejudiceRemover</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(),</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">)</span>

        <span class="c1"># Prepara dati fairlib</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_fold</span><span class="p">)</span>
        <span class="n">train_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_train_fold</span><span class="o">.</span><span class="n">values</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

        <span class="n">test_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_fold</span><span class="p">)</span>
        <span class="n">test_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_fold</span><span class="o">.</span><span class="n">values</span>
        <span class="n">test_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">test_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

        <span class="c1"># Fit</span>
        <span class="n">pr_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">target_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">targets</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sensitive_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">sensitive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">X_test_df</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">pr_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_df</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_pred_bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Metrics</span>
        <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_bin</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_bin</span><span class="p">,</span> <span class="n">X_test_df</span><span class="p">[</span><span class="n">sensitive_col</span><span class="p">])</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test_df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_bin</span><span class="p">)</span>
        <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>

        <span class="c1"># Salva</span>
        <span class="k">if</span> <span class="n">eta</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="n">spd_val</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Baseline] Accuracy: </span><span class="si">{</span><span class="n">perf_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SPD: </span><span class="si">{</span><span class="n">spd_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="n">fold_spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eta</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">mean_spd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_spds</span><span class="p">)</span>
        <span class="n">pr_spd_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">] Mean SPD: </span><span class="si">{</span><span class="n">mean_spd</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.0</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6770</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1216</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6729</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0896</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6829</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0912</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6981</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0845</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.7020</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0834</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.1</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.1</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0975</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.2</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.2</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0995</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.3</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.3</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0881</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.4</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.4</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0994</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PrejudiceRemover η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">eta</span> <span class="ow">in</span> <span class="n">etas</span> <span class="k">if</span> <span class="n">eta</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">spds</span> <span class="o">=</span> <span class="p">[</span><span class="n">baseline_spd_val</span><span class="p">]</span> <span class="o">+</span> <span class="n">pr_spd_vals</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">model_names</span><span class="p">,</span>
    <span class="s1">&#39;SPD&#39;</span><span class="p">:</span> <span class="n">spds</span>
<span class="p">})</span>

<span class="c1"># Plot SPD</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;SPD&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;mediumseagreen&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Statistical Parity Difference (SPD) - PrejudiceRemover&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;|SPD|&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_216_0.png" src="_images/main_216_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;== Bar plot per η = </span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Performance metrics</span>
    <span class="n">inproc_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_performance_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_perf_dict</span><span class="p">,</span>
        <span class="n">base_perf_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (PrejudiceRemover η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Fairness metrics</span>
    <span class="n">inproc_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_fairness_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_fair_dict</span><span class="p">,</span>
        <span class="n">base_fair_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (PrejudiceRemover η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_217_1.png" src="_images/main_217_1.png" />
<img alt="_images/main_217_2.png" src="_images/main_217_2.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_217_4.png" src="_images/main_217_4.png" />
<img alt="_images/main_217_5.png" src="_images/main_217_5.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_217_7.png" src="_images/main_217_7.png" />
<img alt="_images/main_217_8.png" src="_images/main_217_8.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_217_10.png" src="_images/main_217_10.png" />
<img alt="_images/main_217_11.png" src="_images/main_217_11.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etas_inprocessing</span> <span class="o">=</span> <span class="p">[</span><span class="n">eta</span> <span class="k">for</span> <span class="n">eta</span> <span class="ow">in</span> <span class="n">etas</span> <span class="k">if</span> <span class="n">eta</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>

<span class="n">accuracies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">precisions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">recalls</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">aucs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">metrics_list</span> <span class="ow">in</span> <span class="n">inprocessing_performance_metrics</span><span class="p">:</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
    <span class="n">accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]))</span>
    <span class="n">precisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]))</span>
    <span class="n">recalls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]))</span>
    <span class="n">aucs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]))</span>

<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">etas_inprocessing</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">etas_inprocessing</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">etas_inprocessing</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">etas_inprocessing</span><span class="p">,</span> <span class="n">aucs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Regularization Strength η (PrejudiceRemover)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Metric Value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Performance Metrics vs η (PrejudiceRemover)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_218_0.png" src="_images/main_218_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etas_inprocessing</span> <span class="o">=</span> <span class="p">[</span><span class="n">eta</span> <span class="k">for</span> <span class="n">eta</span> <span class="ow">in</span> <span class="n">etas</span> <span class="k">if</span> <span class="n">eta</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>

<span class="n">dprs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">eors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">metrics_list</span> <span class="ow">in</span> <span class="n">inprocessing_fairness_metrics</span><span class="p">:</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
    <span class="n">dprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;dpr&#39;</span><span class="p">]))</span>
    <span class="n">eors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;eor&#39;</span><span class="p">]))</span>

<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">etas_inprocessing</span><span class="p">,</span> <span class="n">dprs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;DPR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">etas_inprocessing</span><span class="p">,</span> <span class="n">eors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EOR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Regularization Strength η (PrejudiceRemover)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fairness Metric&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fairness Metrics vs η (PrejudiceRemover)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_219_0.png" src="_images/main_219_0.png" />
</section>
<section id="results-using-different-stratification">
<h4>Results using different stratification<a class="headerlink" href="#results-using-different-stratification" title="Link to this heading">¶</a></h4>
<section id="id4">
<h5>Adversarial Debiasing<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fairlib.inprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdversarialDebiasing</span>

<span class="n">k</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Suddivisione in training e test set</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
    <span class="n">sensitive_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">][</span><span class="n">sensitive_feature</span><span class="p">]</span>
    <span class="n">sensitive_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">][</span><span class="n">sensitive_feature</span><span class="p">]</span>

    <span class="c1"># Aggiungi la colonna &#39;sensitive&#39; per fairlib</span>
    <span class="n">X_train_copy</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_train_copy</span><span class="p">[</span><span class="s2">&quot;sensitive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitive_train</span><span class="o">.</span><span class="n">values</span>
    <span class="n">X_train_dataframe</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_copy</span><span class="p">)</span>
    <span class="n">X_train_dataframe</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="s2">&quot;sensitive&quot;</span>

    <span class="n">X_test_copy</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_test_copy</span><span class="p">[</span><span class="s2">&quot;sensitive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitive_test</span><span class="o">.</span><span class="n">values</span>
    <span class="n">X_test_dataframe</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_copy</span><span class="p">)</span>
    <span class="n">X_test_dataframe</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="s2">&quot;sensitive&quot;</span>

    <span class="c1"># Modello AdversarialDebiasing</span>
    <span class="n">baseline_model</span> <span class="o">=</span> <span class="n">AdversarialDebiasing</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">sensitive_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">lambda_adv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="n">baseline_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Prediction</span>
    <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">baseline_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_pred</span>

    <span class="c1"># Performance metrics</span>
    <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
    <span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>

    <span class="c1"># Fairness metrics</span>
    <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">sensitive_test</span><span class="p">)</span>
    <span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>

    <span class="c1"># SPD evaluation</span>
    <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
    <span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPD Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">spd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">1</span><span class="p">:</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.16671147767321876</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.13577868219051054</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.08214504126914363</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.12147523360621848</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.31919905771495877</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.05390703999442101</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.1667114776732187</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.1357786821905106</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.08214504126914368</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.12147523360621848</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.3191990577149588</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.053907039994421035</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">2</span><span class="p">:</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09359444827962068</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.03841121013858123</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04134866028894907</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.06407012321177541</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.040047114252061256</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.03040552320513265</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0935944482796206</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.038411210138581175</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.04134866028894901</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06407012321177541</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.04004711425206131</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.03040552320513268</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">3</span><span class="p">:</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.20874177960251428</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.11228684766369584</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.1284324086751224</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.17429918134457953</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06751410051351125</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.10337677725118483</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.20874177960251428</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.1122868476636959</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.1284324086751224</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.17429918134457945</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.06751410051351114</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.10337677725118488</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">4</span><span class="p">:</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.1142857142857143</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.04038929440389294</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.058819192139706405</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.053783180352269894</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.34514689788702746</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.33797393364928907</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.11428571428571421</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04038929440389305</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.05881919213970643</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.05378318035226992</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.3451468978870275</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.33797393364928907</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">5</span><span class="p">:</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.167975874722959</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.12483643295038896</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.05000585531727869</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.09374018026957744</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.02862193787355838</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.07938388625592416</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.16797587472295905</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.12483643295038893</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.050005855317278636</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09374018026957742</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.02862193787355838</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.07938388625592419</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In-processing con Adversarial Debiasing su diversi lambda_adv</span>
<span class="n">adv_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">adv_spds</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adv_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== Adversarial Debiasing con lambda_adv=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Crea liste per ciascun lambda</span>
    <span class="n">perf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fair_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spd_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> - lambda_adv=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Split dei dati</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">sensitive_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">][</span><span class="n">sensitive_feature</span><span class="p">]</span>
        <span class="n">sensitive_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">][</span><span class="n">sensitive_feature</span><span class="p">]</span>

        <span class="c1"># Prepara fairlib dataframe</span>
        <span class="n">X_train_copy</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X_train_copy</span><span class="p">[</span><span class="s2">&quot;sensitive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitive_train</span><span class="o">.</span><span class="n">values</span>
        <span class="n">X_tr</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_copy</span><span class="p">)</span>
        <span class="n">X_tr</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="s2">&quot;sensitive&quot;</span>

        <span class="n">X_test_copy</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X_test_copy</span><span class="p">[</span><span class="s2">&quot;sensitive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitive_test</span><span class="o">.</span><span class="n">values</span>
        <span class="n">X_te</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_copy</span><span class="p">)</span>
        <span class="n">X_te</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="s2">&quot;sensitive&quot;</span>

        <span class="c1"># Modello Adversarial Debiasing</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">AdversarialDebiasing</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">sensitive_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">lambda_adv</span><span class="o">=</span><span class="n">lam</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Addestramento</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># Predizione</span>
        <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_pred</span>

        <span class="c1"># Performance</span>
        <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
        <span class="n">perf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>

        <span class="c1"># Fairness</span>
        <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">sensitive_test</span><span class="p">)</span>
        <span class="n">fair_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>

        <span class="c1"># SPD</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
        <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="n">spd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPD Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">spd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Salva i risultati complessivi del lambda</span>
    <span class="n">inprocessing_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_list</span><span class="p">)</span>
    <span class="n">inprocessing_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_list</span><span class="p">)</span>
    <span class="n">adv_spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_list</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">==</span>

<span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">1</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0059441194637212535</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.015558188655916752</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.016120194483279088</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.01926734474489375</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.23439340400471143</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.1007705986959099</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.005944119463721198</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.015558188655916738</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.01612019448327906</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.019267344744893777</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.23439340400471143</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.10077059869590987</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">2</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0901427896668241</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0672299211787131</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.03649814437043772</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.02537831803522697</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.35159010600706714</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09173960040447714</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09014278966682421</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.06722992117871307</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.036498144370437746</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.025378318035226943</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.3515901060070671</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.09173960040447715</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">3</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.07215056498201504</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04952861779403431</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.07418325552749179</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.09492268254362027</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.11608721272834413</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.05361374407582939</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.072150564982015</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.04952861779403428</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.07418325552749183</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09492268254362024</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.1160872127283441</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.05361374407582942</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">4</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.01737213403880071</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.002311435523114358</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.008201781462210067</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.003382121888695952</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.17198417375199931</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.05242890995260663</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.01737213403880067</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0023114355231144135</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.008201781462210067</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0033821218886960214</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.17198417375199926</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.05242890995260663</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">5</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09820877084620136</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09665653495440729</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.030148378077113805</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0629868518977921</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.04975166259786176</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.09419431279620853</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.09820877084620139</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.09665653495440729</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.03014837807711379</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06298685189779218</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04975166259786179</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.09419431279620849</span><span class="p">}</span>

<span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">==</span>

<span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">1</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">2</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.020971551066380843</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.03282674772036474</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.032364724098895584</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.04093277102455966</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.03180212014134275</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.032009484291641965</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.020971551066380933</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.03282674772036476</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.03236472409889557</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04093277102455961</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.03180212014134276</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.032009484291641965</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">3</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">4</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.010846560846560846</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.013990267639902677</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.017237764916962925</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.015835607376168032</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.013553329404832056</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.013625592417061612</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.010846560846560882</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.013990267639902632</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.01723776491696294</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.01583560737616796</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.013553329404832004</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.013625592417061627</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">5</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">==</span>

<span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">1</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">2</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">3</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">4</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0006172839506172839</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0006082725060827251</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0014992503748125937</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.001199040767386091</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0005892751915144372</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0005924170616113745</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0006172839506173311</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0006082725060827521</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.0014992503748125774</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0011990407673860837</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0005892751915144157</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0005924170616113944</span><span class="p">}</span>

<span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">SPD</span> <span class="n">Fold</span> <span class="mi">5</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adv_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;== Bar plot per λ = </span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Performance</span>
    <span class="n">inproc_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_performance_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_perf_dict</span><span class="p">,</span>
        <span class="n">base_perf_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (Adversarial λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Fairness</span>
    <span class="n">inproc_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_fairness_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_fair_dict</span><span class="p">,</span>
        <span class="n">base_fair_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (Adversarial λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_225_1.png" src="_images/main_225_1.png" />
<img alt="_images/main_225_2.png" src="_images/main_225_2.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_225_4.png" src="_images/main_225_4.png" />
<img alt="_images/main_225_5.png" src="_images/main_225_5.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_225_7.png" src="_images/main_225_7.png" />
<img alt="_images/main_225_8.png" src="_images/main_225_8.png" />
</section>
<section id="id5">
<h5>FaUCI<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">reg_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">fauci_spd_vals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reg_weights</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reg_weights</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== FaUCI training with regularization weight: </span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>
    <span class="n">fold_spds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">X_train_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">X_test_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">y_train_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">y_test_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>

        <span class="n">input_dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">X_test_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_test_fold</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">Simple_NN</span><span class="p">(</span><span class="n">input_dim</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

        <span class="n">fauci_model</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">Fauci</span><span class="p">(</span>
            <span class="n">torchModel</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
            <span class="n">loss</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(),</span>
            <span class="n">fairness_regularization</span><span class="o">=</span><span class="s2">&quot;spd&quot;</span><span class="p">,</span>
            <span class="n">regularization_weight</span><span class="o">=</span><span class="n">weight</span>
        <span class="p">)</span>

        <span class="c1"># Prepara dati fairlib</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_fold</span><span class="p">)</span>
        <span class="n">train_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_train_fold</span><span class="o">.</span><span class="n">values</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

        <span class="c1"># Fit</span>
        <span class="n">fauci_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">fauci_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_tensor</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Metrics</span>
        <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test_fold</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test_fold</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">X_test_fold</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test_fold</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
        <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>

        <span class="c1"># Salva</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="n">spd_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="n">fold_spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weight</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">mean_spd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_spds</span><span class="p">)</span>
        <span class="n">fauci_spd_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[λ=</span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2">] Mean SPD: </span><span class="si">{</span><span class="n">mean_spd</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.0</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.1</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1674</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.2</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.2</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1362</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.3</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.3</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1405</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.4</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.4</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0827</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>  <span class="c1"># Salta λ=0.0 perché è il baseline</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;== Bar plot per λ = </span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Performance metrics</span>
    <span class="n">inproc_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_performance_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_perf_dict</span><span class="p">,</span>
        <span class="n">base_perf_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (FaUCI λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Fairness metrics</span>
    <span class="n">inproc_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_fairness_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_fair_dict</span><span class="p">,</span>
        <span class="n">base_fair_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (FaUCI λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_229_1.png" src="_images/main_229_1.png" />
<img alt="_images/main_229_2.png" src="_images/main_229_2.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_229_4.png" src="_images/main_229_4.png" />
<img alt="_images/main_229_5.png" src="_images/main_229_5.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_229_7.png" src="_images/main_229_7.png" />
<img alt="_images/main_229_8.png" src="_images/main_229_8.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_229_10.png" src="_images/main_229_10.png" />
<img alt="_images/main_229_11.png" src="_images/main_229_11.png" />
</section>
<section id="id6">
<h5>Prejudice Remover<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">etas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">pr_spd_vals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">etas</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">etas</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etas</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== PrejudiceRemover training with eta: </span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>
    <span class="n">fold_spds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">X_train_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">X_test_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">y_train_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">y_test_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>

        <span class="n">input_dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">Simple_NN</span><span class="p">(</span><span class="n">input_dim</span><span class="p">)</span>
        <span class="n">pr_model</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">PrejudiceRemover</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(),</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">)</span>

        <span class="c1"># Prepara dati fairlib</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_fold</span><span class="p">)</span>
        <span class="n">train_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_train_fold</span><span class="o">.</span><span class="n">values</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

        <span class="n">test_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_fold</span><span class="p">)</span>
        <span class="n">test_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_fold</span><span class="o">.</span><span class="n">values</span>
        <span class="n">test_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">test_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

        <span class="c1"># Fit</span>
        <span class="n">pr_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">target_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">targets</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sensitive_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">sensitive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">X_test_df</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">pr_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_df</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_pred_bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Metrics</span>
        <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_bin</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_bin</span><span class="p">,</span> <span class="n">X_test_df</span><span class="p">[</span><span class="n">sensitive_col</span><span class="p">])</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test_df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_bin</span><span class="p">)</span>
        <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>

        <span class="c1"># Salva</span>
        <span class="k">if</span> <span class="n">eta</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="n">spd_val</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Baseline] Accuracy: </span><span class="si">{</span><span class="n">perf_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SPD: </span><span class="si">{</span><span class="n">spd_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="n">fold_spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eta</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">mean_spd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_spds</span><span class="p">)</span>
        <span class="n">pr_spd_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">] Mean SPD: </span><span class="si">{</span><span class="n">mean_spd</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.0</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6819</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1488</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6960</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1410</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6907</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1611</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6954</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1986</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.7042</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1477</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.1</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.1</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1480</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.2</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.2</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1611</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.3</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.3</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1572</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.4</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">Python</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="mf">3.13</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.13</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">811</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.4</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1680</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;== Bar plot per η = </span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Performance metrics</span>
    <span class="n">inproc_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_performance_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_perf_dict</span><span class="p">,</span>
        <span class="n">base_perf_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (PrejudiceRemover η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Fairness metrics</span>
    <span class="n">inproc_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_fairness_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_fair_dict</span><span class="p">,</span>
        <span class="n">base_fair_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (PrejudiceRemover η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_233_1.png" src="_images/main_233_1.png" />
<img alt="_images/main_233_2.png" src="_images/main_233_2.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_233_4.png" src="_images/main_233_4.png" />
<img alt="_images/main_233_5.png" src="_images/main_233_5.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_233_7.png" src="_images/main_233_7.png" />
<img alt="_images/main_233_8.png" src="_images/main_233_8.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_233_10.png" src="_images/main_233_10.png" />
<img alt="_images/main_233_11.png" src="_images/main_233_11.png" />
</section>
</section>
<section id="results-without-using-cross-validation">
<h4>Results without using Cross-validation<a class="headerlink" href="#results-without-using-cross-validation" title="Link to this heading">¶</a></h4>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">metrics_bar_plot</span><span class="p">(</span><span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">,</span> <span class="n">label1</span><span class="p">,</span> <span class="n">label2</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Metric Comparison (mean ± std)&quot;</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="n">fold_dicts</span><span class="p">):</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">fold</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="n">fold_dicts</span><span class="p">]</span>
            <span class="n">mean_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">std_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_val</span><span class="p">)</span>
            <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stds</span><span class="p">)</span>

    <span class="n">mean1</span><span class="p">,</span> <span class="n">std1</span> <span class="o">=</span> <span class="n">summarise</span><span class="p">(</span><span class="n">dict1</span><span class="p">)</span>
    <span class="n">mean2</span><span class="p">,</span> <span class="n">std2</span> <span class="o">=</span> <span class="n">summarise</span><span class="p">(</span><span class="n">dict2</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">[</span><span class="n">mean1</span><span class="p">,</span> <span class="n">mean2</span><span class="p">],</span> <span class="p">[</span><span class="n">std1</span><span class="p">,</span> <span class="n">std2</span><span class="p">],</span> <span class="p">[</span><span class="n">label1</span><span class="p">,</span> <span class="n">label2</span><span class="p">]):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<section id="id7">
<h5>Adversarial Debiasing<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="c1"># Split into training and testing sets</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X_train</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
<span class="n">X_test</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training set shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Training</span> <span class="nb">set</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">5964</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">Testing</span> <span class="nb">set</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">2556</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_dataframe</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="n">X_train_dataframe</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

<span class="n">baseline_model</span> <span class="o">=</span> <span class="n">AdversarialDebiasing</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sensitive_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">lambda_adv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">baseline_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">X_test_dataframe</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="n">X_test_dataframe</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

<span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">baseline_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_pred</span>
<span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
<span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>

<span class="c1"># Fairness metrics</span>
<span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
<span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>

<span class="c1"># SPD aggiuntivo (usando metodo fairlib)</span>
<span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
<span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Baseline SPD (AdversarialDebiasing λ=0): </span><span class="si">{</span><span class="n">spd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Baseline</span> <span class="n">SPD</span> <span class="p">(</span><span class="n">AdversarialDebiasing</span> <span class="n">λ</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06509136554843284</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.15620939647867432</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04108483832929932</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.06928937247360778</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.10015131984531747</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.04179522135323241</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.06509136554843287</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.15620939647867438</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.04108483832929932</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.06928937247360778</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.10015131984531744</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.04179522135323244</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adv_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">adv_spds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">lam</span> <span class="ow">in</span> <span class="n">adv_weights</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== Adversarial Debiasing con lambda_adv=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="n">X_tr</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">X_tr</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

    <span class="n">X_te</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">X_te</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">AdversarialDebiasing</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">sensitive_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">lambda_adv</span><span class="o">=</span><span class="n">lam</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_pred</span>

    <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
    <span class="n">inprocessing_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>

    <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
    <span class="n">inprocessing_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>

    <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
    <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
    <span class="n">adv_spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPD (λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">spd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">==</span>
<span class="n">SPD</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.07181801630877435</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.1668298653610771</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.00909203748526033</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.020444154468034992</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.21145547273440565</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.12100882542871494</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.07181801630877438</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.16682986536107713</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.00909203748526033</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.020444154468035047</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.21145547273440568</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.12100882542871494</span><span class="p">}</span>

<span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">==</span>
<span class="n">SPD</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

<span class="o">==</span> <span class="n">Adversarial</span> <span class="n">Debiasing</span> <span class="n">con</span> <span class="n">lambda_adv</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">==</span>
<span class="n">SPD</span> <span class="p">(</span><span class="n">λ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="p">{(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">hired</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grouped_regions</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metrics_bar_plot</span><span class="p">(</span>
    <span class="n">inprocessing_performance_metrics</span><span class="p">,</span>
    <span class="n">baseline_performance_metrics</span><span class="p">,</span>
    <span class="s2">&quot;In-processing (Adversarial Debiasing)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">metrics_bar_plot</span><span class="p">(</span>
    <span class="n">inprocessing_fairness_metrics</span><span class="p">,</span>
    <span class="n">baseline_fairness_metrics</span><span class="p">,</span>
    <span class="s2">&quot;In-processing (Adversarial Debiasing)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_240_0.png" src="_images/main_240_0.png" />
<img alt="_images/main_240_1.png" src="_images/main_240_1.png" />
</section>
<section id="id8">
<h5>FaUCI<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="c1"># Split into training and testing sets</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X_train</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
<span class="n">X_test</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training set shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Training</span> <span class="nb">set</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">5964</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">Testing</span> <span class="nb">set</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">2556</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lambdas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>
<span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">lambdas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">lambdas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
<span class="n">fauci_spd_vals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">input_dim</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">for</span> <span class="n">lam</span> <span class="ow">in</span> <span class="n">lambdas</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== FaUCI training with λ = </span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Simple_NN</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">input_dim</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="n">fauci_model</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">Fauci</span><span class="p">(</span>
        <span class="n">torchModel</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(),</span>
        <span class="n">fairness_regularization</span><span class="o">=</span><span class="s2">&quot;spd&quot;</span><span class="p">,</span>
        <span class="n">regularization_weight</span><span class="o">=</span><span class="n">lam</span>
    <span class="p">)</span>

    <span class="c1"># Prepara fairlib DataFrame</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">train_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">values</span>
    <span class="n">train_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
    <span class="n">train_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

    <span class="n">test_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">test_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">values</span>
    <span class="n">test_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
    <span class="n">test_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

    <span class="c1"># Training</span>
    <span class="n">fauci_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Predizione</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">fauci_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_pred_bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Valutazione</span>
    <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_bin</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_bin</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
    <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_bin</span><span class="p">)</span>
    <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lam</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
        <span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
        <span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="n">spd_val</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Baseline] Accuracy: </span><span class="si">{</span><span class="n">perf_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SPD: </span><span class="si">{</span><span class="n">spd_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">lambdas</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
        <span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
        <span class="n">fauci_spd_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">] Accuracy: </span><span class="si">{</span><span class="n">perf_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SPD: </span><span class="si">{</span><span class="n">spd_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">==</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6827</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1008</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">==</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6933</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0973</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">==</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.2</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6608</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0793</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">==</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.3</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6131</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0591</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">==</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.4</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.5540</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0458</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== Bar plot per λ = </span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> (FaUCI) ==&quot;</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">baseline_performance_metrics</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (FaUCI) λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">baseline_fairness_metrics</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (FaUCI) λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="p">(</span><span class="n">FaUCI</span><span class="p">)</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_244_1.png" src="_images/main_244_1.png" />
<img alt="_images/main_244_2.png" src="_images/main_244_2.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="p">(</span><span class="n">FaUCI</span><span class="p">)</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_244_4.png" src="_images/main_244_4.png" />
<img alt="_images/main_244_5.png" src="_images/main_244_5.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="p">(</span><span class="n">FaUCI</span><span class="p">)</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_244_7.png" src="_images/main_244_7.png" />
<img alt="_images/main_244_8.png" src="_images/main_244_8.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="p">(</span><span class="n">FaUCI</span><span class="p">)</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_244_10.png" src="_images/main_244_10.png" />
<img alt="_images/main_244_11.png" src="_images/main_244_11.png" />
</section>
<section id="prejudice-removal">
<h5>Prejudice Removal<a class="headerlink" href="#prejudice-removal" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="c1"># Split into training and testing sets</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X_train</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
<span class="n">X_test</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training set shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Training</span> <span class="nb">set</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">5964</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">Testing</span> <span class="nb">set</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">2556</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>
<span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">etas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">etas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
<span class="n">pr_spd_vals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">input_dim</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">for</span> <span class="n">eta</span> <span class="ow">in</span> <span class="n">etas</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== PrejudiceRemover training with eta: </span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Simple_NN</span><span class="p">(</span><span class="n">input_dim</span><span class="p">)</span>
    <span class="n">pr_model</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">PrejudiceRemover</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(),</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">)</span>

    <span class="c1"># Prepara fairlib DataFrame</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">train_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">values</span>
    <span class="n">train_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
    <span class="n">train_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

    <span class="n">test_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">test_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">values</span>
    <span class="n">test_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
    <span class="n">test_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

    <span class="c1"># Training</span>
    <span class="n">pr_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

    <span class="c1"># Valutazione</span>
    <span class="n">target_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">targets</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sensitive_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">sensitive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">X_test_df</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">pr_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_df</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y_pred_bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Performance</span>
    <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_bin</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="c1"># Fairness</span>
    <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_bin</span><span class="p">,</span> <span class="n">X_test_df</span><span class="p">[</span><span class="n">sensitive_col</span><span class="p">])</span>

    <span class="c1"># SPD</span>
    <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test_df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_bin</span><span class="p">)</span>
    <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eta</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
        <span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
        <span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="n">spd_val</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">etas</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Shift because baseline (eta=0) is excluded</span>
        <span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
        <span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
        <span class="n">pr_spd_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.0</span> <span class="o">==</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.1</span> <span class="o">==</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.2</span> <span class="o">==</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.3</span> <span class="o">==</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.4</span> <span class="o">==</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;== Bar plot per η = </span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>
    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">baseline_performance_metrics</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;PrejudiceRemover η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">baseline_fairness_metrics</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;PrejudiceRemover η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_248_1.png" src="_images/main_248_1.png" />
<img alt="_images/main_248_2.png" src="_images/main_248_2.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_248_4.png" src="_images/main_248_4.png" />
<img alt="_images/main_248_5.png" src="_images/main_248_5.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_248_7.png" src="_images/main_248_7.png" />
<img alt="_images/main_248_8.png" src="_images/main_248_8.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_248_10.png" src="_images/main_248_10.png" />
<img alt="_images/main_248_11.png" src="_images/main_248_11.png" />
</section>
</section>
<section id="results-duplicating-positive-samples">
<h4>Results duplicating positive samples<a class="headerlink" href="#results-duplicating-positive-samples" title="Link to this heading">¶</a></h4>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rnd</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[(</span><span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">df1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df1</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
<section id="id9">
<h5>FaUCI<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">reg_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">fauci_spd_vals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reg_weights</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reg_weights</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== FaUCI training with regularization weight: </span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>
    <span class="n">fold_spds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">X_train_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">X_test_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">y_train_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">y_test_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>

        <span class="n">input_dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">X_test_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_test_fold</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">Simple_NN</span><span class="p">(</span><span class="n">input_dim</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

        <span class="n">fauci_model</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">Fauci</span><span class="p">(</span>
            <span class="n">torchModel</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
            <span class="n">loss</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(),</span>
            <span class="n">fairness_regularization</span><span class="o">=</span><span class="s2">&quot;spd&quot;</span><span class="p">,</span>
            <span class="n">regularization_weight</span><span class="o">=</span><span class="n">weight</span>
        <span class="p">)</span>

        <span class="c1"># Prepara dati fairlib</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_fold</span><span class="p">)</span>
        <span class="n">train_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_train_fold</span><span class="o">.</span><span class="n">values</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

        <span class="c1"># Fit</span>
        <span class="n">fauci_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">fauci_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_tensor</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">y_pred_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Metrics</span>
        <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_test_fold</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test_fold</span><span class="p">,</span> <span class="n">y_pred_labels</span><span class="p">,</span> <span class="n">X_test_fold</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">])</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test_fold</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_labels</span><span class="p">)</span>
        <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>

        <span class="c1"># Salva</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="n">spd_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="n">fold_spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weight</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">mean_spd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_spds</span><span class="p">)</span>
        <span class="n">fauci_spd_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[λ=</span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2">] Mean SPD: </span><span class="si">{</span><span class="n">mean_spd</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.0</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.1</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.1</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0797</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.2</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.2</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0690</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.3</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.3</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0883</span>

<span class="o">==</span> <span class="n">FaUCI</span> <span class="n">training</span> <span class="k">with</span> <span class="n">regularization</span> <span class="n">weight</span><span class="p">:</span> <span class="mf">0.4</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">λ</span><span class="o">=</span><span class="mf">0.4</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0929</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>  <span class="c1"># Salta λ=0.0 perché è il baseline</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;== Bar plot per λ = </span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Performance metrics</span>
    <span class="n">inproc_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_performance_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_perf_dict</span><span class="p">,</span>
        <span class="n">base_perf_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (FaUCI λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Fairness metrics</span>
    <span class="n">inproc_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_fairness_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_fair_dict</span><span class="p">,</span>
        <span class="n">base_fair_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (FaUCI λ=</span><span class="si">{</span><span class="n">lam</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_254_1.png" src="_images/main_254_1.png" />
<img alt="_images/main_254_2.png" src="_images/main_254_2.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_254_4.png" src="_images/main_254_4.png" />
<img alt="_images/main_254_5.png" src="_images/main_254_5.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_254_7.png" src="_images/main_254_7.png" />
<img alt="_images/main_254_8.png" src="_images/main_254_8.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">λ</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_254_10.png" src="_images/main_254_10.png" />
<img alt="_images/main_254_11.png" src="_images/main_254_11.png" />
</section>
<section id="id10">
<h5>Prejudice Removal<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h5>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">etas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">pr_spd_vals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">baseline_performance_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inprocessing_performance_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">etas</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">inprocessing_fairness_metrics</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">etas</span> <span class="k">if</span> <span class="n">_</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span>
<span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etas</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">== PrejudiceRemover training with eta: </span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>
    <span class="n">fold_spds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">X_train_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">X_test_fold</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">y_train_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
        <span class="n">y_test_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>

        <span class="n">input_dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">Simple_NN</span><span class="p">(</span><span class="n">input_dim</span><span class="p">)</span>
        <span class="n">pr_model</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">PrejudiceRemover</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(),</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">)</span>

        <span class="c1"># Prepara dati fairlib</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_fold</span><span class="p">)</span>
        <span class="n">train_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_train_fold</span><span class="o">.</span><span class="n">values</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">train_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

        <span class="n">test_data</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_fold</span><span class="p">)</span>
        <span class="n">test_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_fold</span><span class="o">.</span><span class="n">values</span>
        <span class="n">test_data</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">test_data</span><span class="o">.</span><span class="n">sensitive</span> <span class="o">=</span> <span class="n">sensitive_feature</span>

        <span class="c1"># Fit</span>
        <span class="n">pr_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">target_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">targets</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sensitive_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">sensitive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">X_test_df</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">y_pred_tensor</span> <span class="o">=</span> <span class="n">pr_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_df</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_pred_bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Metrics</span>
        <span class="n">perf_metrics</span> <span class="o">=</span> <span class="n">compute_performance_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_bin</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">fair_metrics</span> <span class="o">=</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_bin</span><span class="p">,</span> <span class="n">X_test_df</span><span class="p">[</span><span class="n">sensitive_col</span><span class="p">])</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test_df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_bin</span><span class="p">)</span>
        <span class="n">spd_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>

        <span class="c1"># Salva</span>
        <span class="k">if</span> <span class="n">eta</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">baseline_performance_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">baseline_spd_val</span> <span class="o">=</span> <span class="n">spd_val</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Baseline] Accuracy: </span><span class="si">{</span><span class="n">perf_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SPD: </span><span class="si">{</span><span class="n">spd_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_metrics</span><span class="p">)</span>
            <span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fair_metrics</span><span class="p">)</span>
            <span class="n">fold_spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spd_val</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eta</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">mean_spd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_spds</span><span class="p">)</span>
        <span class="n">pr_spd_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">] Mean SPD: </span><span class="si">{</span><span class="n">mean_spd</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.0</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6784</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0782</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6784</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1147</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.6789</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0686</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.7088</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0670</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">Baseline</span><span class="p">]</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.7058</span><span class="p">,</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.1072</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.1</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.1</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0901</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.2</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.2</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0986</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.3</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.3</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0957</span>

<span class="o">==</span> <span class="n">PrejudiceRemover</span> <span class="n">training</span> <span class="k">with</span> <span class="n">eta</span><span class="p">:</span> <span class="mf">0.4</span> <span class="o">==</span>
  <span class="n">Fold</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">3</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
  <span class="n">Fold</span> <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>
<span class="p">[</span><span class="n">η</span><span class="o">=</span><span class="mf">0.4</span><span class="p">]</span> <span class="n">Mean</span> <span class="n">SPD</span><span class="p">:</span> <span class="mf">0.0918</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;== Bar plot per η = </span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2"> ==&quot;</span><span class="p">)</span>

    <span class="c1"># Performance metrics</span>
    <span class="n">inproc_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_performance_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_perf_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_performance_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_perf_dict</span><span class="p">,</span>
        <span class="n">base_perf_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (PrejudiceRemover η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Fairness metrics</span>
    <span class="n">inproc_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">inprocessing_fairness_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">base_fair_dict</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">baseline_fairness_metrics</span><span class="p">)</span>

    <span class="n">metrics_bar_plot</span><span class="p">(</span>
        <span class="n">inproc_fair_dict</span><span class="p">,</span>
        <span class="n">base_fair_dict</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;In-processing (PrejudiceRemover η=</span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Baseline&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;dpr&quot;</span><span class="p">,</span> <span class="s2">&quot;eor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_258_1.png" src="_images/main_258_1.png" />
<img alt="_images/main_258_2.png" src="_images/main_258_2.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_258_4.png" src="_images/main_258_4.png" />
<img alt="_images/main_258_5.png" src="_images/main_258_5.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_258_7.png" src="_images/main_258_7.png" />
<img alt="_images/main_258_8.png" src="_images/main_258_8.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="n">per</span> <span class="n">η</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">==</span>
</pre></div>
</div>
<img alt="_images/main_258_10.png" src="_images/main_258_10.png" />
<img alt="_images/main_258_11.png" src="_images/main_258_11.png" />
<p>The result for fairness metrics show a significant improvement</p>
</section>
</section>
</section>
<section id="post-processing">
<h3>Post-Processing<a class="headerlink" href="#post-processing" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sensitive_feature</span> <span class="o">=</span> <span class="s1">&#39;grouped_regions&#39;</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;hired&#39;</span>
<span class="n">postproc_df</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">],</span> <span class="n">df1</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">normalize</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>hired</th>
      <th>0</th>
      <th>1</th>
    </tr>
    <tr>
      <th>grouped_regions</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0</th>
      <td>0.358491</td>
      <td>0.641509</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>0.523649</td>
      <td>0.476351</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>0.370315</td>
      <td>0.629685</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>0.391954</td>
      <td>0.608046</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>0.939394</td>
      <td>0.060606</td>
    </tr>
    <tr>
      <th>5.0</th>
      <td>0.475610</td>
      <td>0.524390</td>
    </tr>
  </tbody>
</table>
</div><p>The distribution of the discriminated group is extremely skewed towards
label 0, and by observing the data we can easily check that we have only
2 positive examples for that category, therefore there is a problem in
the protocol itself when we split in training and test.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">south_females_hired</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">postproc_df</span><span class="p">[(</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)])</span>
<span class="n">south_females_not_hired</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">postproc_df</span><span class="p">[(</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of females coming from the south of Italy that was hired: </span><span class="si">{</span><span class="n">south_females_hired</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of females coming from the south of Italy that was not hired: </span><span class="si">{</span><span class="n">south_females_not_hired</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Number</span> <span class="n">of</span> <span class="n">females</span> <span class="n">coming</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">south</span> <span class="n">of</span> <span class="n">Italy</span> <span class="n">that</span> <span class="n">was</span> <span class="n">hired</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">females</span> <span class="n">coming</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">south</span> <span class="n">of</span> <span class="n">Italy</span> <span class="n">that</span> <span class="n">was</span> <span class="ow">not</span> <span class="n">hired</span><span class="p">:</span> <span class="mi">31</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">minority_encoding</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>

<span class="n">privileged_groups</span> <span class="o">=</span> <span class="p">[{</span><span class="n">sensitive_feature</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">postproc_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">minority_encoding</span><span class="p">]</span>
<span class="n">unprivileged_groups</span> <span class="o">=</span> <span class="p">[{</span><span class="n">sensitive_feature</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">minority_encoding</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PostProcessingAlgorithms</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CALIBRATED_EQ_ODDS</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">EQ_ODDS</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">REJECTED_OPTION_CLASSIFICATION</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">aif360_PostProcessing_Wrapper</span><span class="p">():</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">algorithm</span><span class="p">:</span><span class="n">PostProcessingAlgorithms</span><span class="p">,</span>
                 <span class="n">unprivileged_groups</span><span class="p">:</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
                 <span class="n">privileged_groups</span><span class="p">:</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">priv_groups</span> <span class="o">=</span> <span class="n">privileged_groups</span>

        <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="n">PostProcessingAlgorithms</span><span class="o">.</span><span class="n">CALIBRATED_EQ_ODDS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">CalibratedEqOddsPostprocessing</span><span class="p">(</span><span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span> <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="n">PostProcessingAlgorithms</span><span class="o">.</span><span class="n">EQ_ODDS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">EqOddsPostprocessing</span><span class="p">(</span><span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span> <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="n">PostProcessingAlgorithms</span><span class="o">.</span><span class="n">REJECTED_OPTION_CLASSIFICATION</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">RejectOptionClassification</span><span class="p">(</span><span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span> <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;The specified algorithm does not exists&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_label</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">StandardDataset</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                            <span class="n">target</span><span class="p">,</span>
                            <span class="n">favorable_classes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">protected_attribute_names</span><span class="o">=</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">],</span>
                            <span class="n">privileged_classes</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priv_groups</span><span class="p">],</span>
                            <span class="n">scores_name</span><span class="o">=</span><span class="s1">&#39;scores&#39;</span> <span class="k">if</span> <span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">):</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_scores</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">ds_true</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_dataset</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_label</span><span class="o">=</span><span class="n">y_true</span><span class="p">)</span>
        <span class="n">ds_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_dataset</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_label</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="n">y_scores</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset_true</span><span class="o">=</span><span class="n">ds_true</span><span class="p">,</span> <span class="n">dataset_pred</span><span class="o">=</span><span class="n">ds_pred</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">):</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_scores</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ds_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_dataset</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_label</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="n">y_scores</span><span class="p">)</span>

        <span class="n">mitigated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">ds_pred</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mitigated</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">calib_eq_odds</span> <span class="o">=</span> <span class="n">aif360_PostProcessing_Wrapper</span><span class="p">(</span><span class="n">PostProcessingAlgorithms</span><span class="o">.</span><span class="n">CALIBRATED_EQ_ODDS</span><span class="p">,</span>
                                              <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                              <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span>
                                            <span class="p">)</span>

<span class="n">eq_odds</span> <span class="o">=</span> <span class="n">aif360_PostProcessing_Wrapper</span><span class="p">(</span><span class="n">PostProcessingAlgorithms</span><span class="o">.</span><span class="n">EQ_ODDS</span><span class="p">,</span>
                                              <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                              <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span>
                                            <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">postproc_baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">eq_odds_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">calib_eq_odds_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">spds</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">postproc_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">base_clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
<span class="n">base_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_scores_train</span> <span class="o">=</span> <span class="n">base_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="n">y_pred_test</span> <span class="o">=</span> <span class="n">base_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_scores_test</span> <span class="o">=</span> <span class="n">base_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_pred_test</span><span class="p">)</span>
<span class="n">spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">))</span>

<span class="n">df_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_train</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_train</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_test</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>

<span class="n">postproc_baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_test</span><span class="p">,</span> <span class="n">df_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]))</span>

<span class="n">calib_eq_odds</span> <span class="o">=</span> <span class="n">calib_eq_odds</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_scores_train</span><span class="p">)</span>
<span class="n">transformed_pred</span> <span class="o">=</span> <span class="n">calib_eq_odds</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_scores_test</span><span class="p">)</span>
<span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">transformed_pred</span><span class="p">)</span>
<span class="n">spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">))</span>

<span class="n">eq_odds</span> <span class="o">=</span> <span class="n">eq_odds</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_scores_train</span><span class="p">)</span>
<span class="n">transformed_eq_pred</span> <span class="o">=</span> <span class="n">eq_odds</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_scores_test</span><span class="p">)</span>
<span class="n">spd</span> <span class="o">=</span> <span class="n">evaluate_spd</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">transformed_eq_pred</span><span class="p">)</span>
<span class="n">spds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spd</span><span class="p">))</span>

<span class="n">calib_eq_odds_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">transformed_pred</span><span class="p">,</span> <span class="n">df_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]))</span>
<span class="n">eq_odds_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">transformed_eq_pred</span><span class="p">,</span> <span class="n">df_test</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metrics_bar_plot</span><span class="p">(</span><span class="n">postproc_baseline_fairness_metrics</span><span class="p">,</span>
                 <span class="n">calib_eq_odds_fairness_metrics</span><span class="p">,</span>
                 <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;w/o post-processing&#39;</span><span class="p">,</span>
                 <span class="n">label2</span><span class="o">=</span><span class="s1">&#39;with post-processing&#39;</span><span class="p">,</span>
                 <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dpr&#39;</span><span class="p">,</span><span class="s1">&#39;eor&#39;</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Baseline vs Calibrated Equalized Odds&quot;</span><span class="p">)</span>

<span class="n">metrics_bar_plot</span><span class="p">(</span><span class="n">postproc_baseline_fairness_metrics</span><span class="p">,</span>
                 <span class="n">eq_odds_fairness_metrics</span><span class="p">,</span>
                 <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;w/o post-processing&#39;</span><span class="p">,</span>
                 <span class="n">label2</span><span class="o">=</span><span class="s1">&#39;with post-processing&#39;</span><span class="p">,</span>
                 <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dpr&#39;</span><span class="p">,</span><span class="s1">&#39;eor&#39;</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Baseline vs Equalized Odds&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_270_0.png" src="_images/main_270_0.png" />
<img alt="_images/main_270_1.png" src="_images/main_270_1.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">,</span> <span class="s1">&#39;Equalized Odds&#39;</span><span class="p">,</span> <span class="s1">&#39;Calibrated Equalized Odds&#39;</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">model_names</span><span class="p">,</span>
    <span class="s1">&#39;SPD&#39;</span><span class="p">:</span> <span class="n">spds</span>
<span class="p">})</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SPD&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Statistical Parity Difference (SPD)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;|SPD|&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/main_271_0.png" src="_images/main_271_0.png" />
<p>Because the protected slice has only two positive cases, hard-threshold
Equalized Odds finds no feasible adjustment and leaves the metrics
unchanged, whereas the more flexible Calibrated Equalized Odds can
re-label one borderline instance.</p>
<p>To obtain reliable fairness metrics, we stratify the K-fold split on the
joint distribution of the target label and the sensitive attribute,
ensuring each fold contains a proportional share of every (target,
sensitive-group) combination.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">13.0</span>    <span class="mi">2645</span>
<span class="mf">12.0</span>    <span class="mi">2100</span>
<span class="mf">03.0</span>    <span class="mi">1705</span>
<span class="mf">02.0</span>    <span class="mi">1235</span>
<span class="mf">10.0</span>     <span class="mi">272</span>
<span class="mf">01.0</span>     <span class="mi">155</span>
<span class="mf">00.0</span>     <span class="mi">152</span>
<span class="mf">11.0</span>     <span class="mi">141</span>
<span class="mf">15.0</span>      <span class="mi">43</span>
<span class="mf">05.0</span>      <span class="mi">39</span>
<span class="mf">04.0</span>      <span class="mi">31</span>
<span class="mf">14.0</span>       <span class="mi">2</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">postproc_baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">eq_odds_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">calib_eq_odds_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">postproc_df</span><span class="p">,</span> <span class="n">postproc_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">test_df</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">train_df</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>

    <span class="n">train_scores</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">test_scores</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_scores</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">postproc_baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]))</span>

    <span class="n">calib_eq_odds</span> <span class="o">=</span> <span class="n">aif360_PostProcessing_Wrapper</span><span class="p">(</span><span class="n">PostProcessingAlgorithms</span><span class="o">.</span><span class="n">CALIBRATED_EQ_ODDS</span><span class="p">,</span>
                                                <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                                <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span>
                                                <span class="p">)</span>

    <span class="n">eq_odds</span> <span class="o">=</span> <span class="n">aif360_PostProcessing_Wrapper</span><span class="p">(</span><span class="n">PostProcessingAlgorithms</span><span class="o">.</span><span class="n">EQ_ODDS</span><span class="p">,</span>
                                                <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                                <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span>
                                                <span class="p">)</span>


    <span class="n">calib_eq_odds</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">train_scores</span><span class="p">)</span>
    <span class="n">eq_odds</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">train_scores</span><span class="p">)</span>

    <span class="n">calib_eq_odds_trans_pred</span> <span class="o">=</span> <span class="n">calib_eq_odds</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">test_scores</span><span class="p">)</span>
    <span class="n">eq_odds_trans_pred</span> <span class="o">=</span> <span class="n">eq_odds</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">test_scores</span><span class="p">)</span>

    <span class="n">calib_eq_odds_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">calib_eq_odds_trans_pred</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]))</span>
    <span class="n">eq_odds_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">eq_odds_trans_pred</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">kor</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.10</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sklearn</span><span class="o">/</span><span class="n">model_selection</span><span class="o">/</span><span class="n">_split</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">805</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">least</span> <span class="n">populated</span> <span class="k">class</span><span class="w"> </span><span class="nc">in</span> <span class="n">y</span> <span class="n">has</span> <span class="n">only</span> <span class="mi">2</span> <span class="n">members</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">n_splits</span><span class="o">=</span><span class="mf">5.</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metrics_bar_plot</span><span class="p">(</span><span class="n">postproc_baseline_fairness_metrics</span><span class="p">,</span>
                 <span class="n">calib_eq_odds_fairness_metrics</span><span class="p">,</span>
                 <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;w/o post-processing&#39;</span><span class="p">,</span>
                 <span class="n">label2</span><span class="o">=</span><span class="s1">&#39;with post-processing&#39;</span><span class="p">,</span>
                 <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dpr&#39;</span><span class="p">,</span><span class="s1">&#39;eor&#39;</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Baseline vs Calibrated Equalized Odds&quot;</span><span class="p">)</span>

<span class="n">metrics_bar_plot</span><span class="p">(</span><span class="n">postproc_baseline_fairness_metrics</span><span class="p">,</span>
                 <span class="n">eq_odds_fairness_metrics</span><span class="p">,</span>
                 <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;w/o post-processing&#39;</span><span class="p">,</span>
                 <span class="n">label2</span><span class="o">=</span><span class="s1">&#39;with post-processing&#39;</span><span class="p">,</span>
                 <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dpr&#39;</span><span class="p">,</span><span class="s1">&#39;eor&#39;</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Baseline vs Equalized Odds&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_276_0.png" src="_images/main_276_0.png" />
<img alt="_images/main_276_1.png" src="_images/main_276_1.png" />
<p>For the same reason of before, the eq_dots produces the same results as
the baseline since it leaves the predictions as they are, while the
calibrated_eq_dots improves the solution. Then, if we look at the
variance in the boxplot, we can notice that the mean+std of the baseline
metrics and the calibrated_eq_odds are the same as before (without cross
validation). This is probably because the techniques are highly
dependent on the sensitive feature distribution, that in our case is
extremely skewed and contains only two positive examples. We can test
this assumption later by duplicating (i.e. oversampling) the positive
labels and observing the behaviour of the post processing</p>
<p>In particular, because EOR compares true positive rates across groups,
having only 2 positive examples in the protected group means that even
one misclassification causes a large drop in $ P(:raw-latex:<a href="#id11"><span class="problematic" id="id12">`</span></a>hat{Y}`=1
| Y=1, S=s) $ (i.e. The probability that the model predicts a positive
outcome, given that the true label is positive and the individual
belongs to sensitive group s), making the ratio unstable and difficult
to improve, while the skewed label distribution limits the ability of
the model to predict positives, keeping both EOR and DPR low regardless
of post-processing.</p>
<p>If we oversample the positive examples with respect to the sensitive
feature:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pos</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="p">[(</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">neg</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="p">[(</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">pos_oversamples</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">neg_oversamples</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pos_oversamples</span><span class="p">):</span>
    <span class="n">postproc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">postproc_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">postproc_df</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">neg_oversamples</span><span class="p">):</span>
        <span class="n">postproc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">neg</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">postproc_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">postproc_df</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.03.0</span>    <span class="mi">2645</span>
<span class="mf">1.02.0</span>    <span class="mi">2100</span>
<span class="mf">0.03.0</span>    <span class="mi">1705</span>
<span class="mf">0.02.0</span>    <span class="mi">1235</span>
<span class="mf">1.00.0</span>     <span class="mi">272</span>
<span class="mf">0.01.0</span>     <span class="mi">155</span>
<span class="mf">0.00.0</span>     <span class="mi">152</span>
<span class="mf">1.01.0</span>     <span class="mi">141</span>
<span class="mf">1.05.0</span>      <span class="mi">43</span>
<span class="mf">0.05.0</span>      <span class="mi">39</span>
<span class="mf">0.04.0</span>      <span class="mi">31</span>
<span class="mf">1.04.0</span>       <span class="mi">8</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">postproc_baseline_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">eq_odds_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">calib_eq_odds_fairness_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">postproc_df</span><span class="p">,</span> <span class="n">postproc_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="n">postproc_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))):</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">test_df</span> <span class="o">=</span> <span class="n">postproc_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">train_df</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>

    <span class="n">train_scores</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">test_scores</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_scores</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">postproc_baseline_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]))</span>

    <span class="n">calib_eq_odds</span> <span class="o">=</span> <span class="n">aif360_PostProcessing_Wrapper</span><span class="p">(</span><span class="n">PostProcessingAlgorithms</span><span class="o">.</span><span class="n">CALIBRATED_EQ_ODDS</span><span class="p">,</span>
                                                <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                                <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span>
                                                <span class="p">)</span>

    <span class="n">eq_odds</span> <span class="o">=</span> <span class="n">aif360_PostProcessing_Wrapper</span><span class="p">(</span><span class="n">PostProcessingAlgorithms</span><span class="o">.</span><span class="n">EQ_ODDS</span><span class="p">,</span>
                                                <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                                <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span>
                                                <span class="p">)</span>


    <span class="n">calib_eq_odds</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">train_scores</span><span class="p">)</span>
    <span class="n">eq_odds</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">train_scores</span><span class="p">)</span>

    <span class="n">calib_eq_odds_trans_pred</span> <span class="o">=</span> <span class="n">calib_eq_odds</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">test_scores</span><span class="p">)</span>
    <span class="n">eq_odds_trans_pred</span> <span class="o">=</span> <span class="n">eq_odds</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">test_scores</span><span class="p">)</span>

    <span class="n">calib_eq_odds_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">calib_eq_odds_trans_pred</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]))</span>
    <span class="n">eq_odds_fairness_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">compute_fairness_metrics</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">eq_odds_trans_pred</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="n">sensitive_feature</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metrics_bar_plot</span><span class="p">(</span><span class="n">postproc_baseline_fairness_metrics</span><span class="p">,</span>
                 <span class="n">calib_eq_odds_fairness_metrics</span><span class="p">,</span>
                 <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;w/o post-processing&#39;</span><span class="p">,</span>
                 <span class="n">label2</span><span class="o">=</span><span class="s1">&#39;with post-processing&#39;</span><span class="p">,</span>
                 <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dpr&#39;</span><span class="p">,</span><span class="s1">&#39;eor&#39;</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Baseline vs Calibrated Equalized Odds&quot;</span><span class="p">)</span>

<span class="n">metrics_bar_plot</span><span class="p">(</span><span class="n">postproc_baseline_fairness_metrics</span><span class="p">,</span>
                 <span class="n">eq_odds_fairness_metrics</span><span class="p">,</span>
                 <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;w/o post-processing&#39;</span><span class="p">,</span>
                 <span class="n">label2</span><span class="o">=</span><span class="s1">&#39;with post-processing&#39;</span><span class="p">,</span>
                 <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dpr&#39;</span><span class="p">,</span><span class="s1">&#39;eor&#39;</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Baseline vs Equalized Odds&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/main_283_0.png" src="_images/main_283_0.png" />
<img alt="_images/main_283_1.png" src="_images/main_283_1.png" />
<p>We can observe that the Calibrated Equalized Odds further improves the
metrics, but this can just give us an intuition since it is not a real
data augmentation. A possible improvement would be to use a powerful
data augmentation technique such as SMOTHE in order to produce results
according to the real distribution.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Fair-Candidate-Screening-System</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fair Candidate Screening System</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dataset-loading">Dataset Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-preparation">Data Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-preprocessing">Data Preprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bias-detection">Bias detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bias-mitigation-techniques">Bias mitigation techniques</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Welcome to Fair Candidate Screening System’s documentation!</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/main.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>